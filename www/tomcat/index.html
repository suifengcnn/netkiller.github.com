<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>第 2 章 Apache Tomcat</title><link rel="stylesheet" type="text/css" href="..//docbook.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><meta name="keywords" content="lamp,lnmp,famp,fnmp, cgi,fastcgi,wsgi, apache,lighttpd,nginx,tomcat, awstatus, webalizer" /><link rel="home" href="../index.html" title="Netkiller Linux Web 手札" /><link rel="up" href="../index.html" title="Netkiller Linux Web 手札" /><link rel="prev" href="../nginx/faq.html" title="1.6. FAQ" /><link rel="next" href="conf.html" title="2.2. 配置 Tomcat 服务器" /></head><body><a xmlns="" href="//www.netkiller.cn/">Home</a> |
		<a xmlns="" href="//netkiller.github.io/">简体中文</a> |
	    <a xmlns="" href="http://netkiller.sourceforge.net/">繁体中文</a> |
	    <a xmlns="" href="/journal/index.html">杂文</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/donations.html">打赏(Donations)</a> |
	    <a xmlns="" href="https://github.com/netkiller">Github</a> |
	    <a xmlns="" href="http://my.oschina.net/neochen/">OSChina 博客</a> |
	    <a xmlns="" href="https://cloud.tencent.com/developer/column/2078">云社区</a> |
	    <a xmlns="" href="https://yq.aliyun.com/u/netkiller/">云栖社区</a> |
	    <a xmlns="" href="https://www.facebook.com/bg7nyt">Facebook</a> |
	    <a xmlns="" href="http://cn.linkedin.com/in/netkiller/">Linkedin</a> |
	    <a xmlns="" href="https://zhuanlan.zhihu.com/netkiller">知乎专栏</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/video.html">视频教程</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/about.html">About</a><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">第 2 章 Apache Tomcat</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="../nginx/faq.html">上一页</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="conf.html">下一页</a></td></tr></table><hr /></div><table xmlns=""><tr><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=watch&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=fork&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;type=follow&amp;count=true&amp;size=large" height="30" width="240" frameborder="0" scrolling="0" style="width:240px; height: 30px;" allowTransparency="true"></iframe></td></tr></table><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="index"></a>第 2 章 Apache Tomcat</h1></div></div></div><div class="toc"><p><strong>目录</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#install">2.1. Tomcat 安装与配置</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#tomcat6">2.1.1. Tomcat 6</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#idp56">2.1.1.1. tomcat-native</a></span></dt><dt><span class="section"><a href="index.html#idp57">2.1.1.2. 启动脚本</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#tomcat7">2.1.2. Tomcat 7</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#idp58">2.1.2.1. Server JRE</a></span></dt><dt><span class="section"><a href="index.html#idp59">2.1.2.2. Tomcat</a></span></dt></dl></dd><dt><span class="section"><a href="index.html#tomcat8">2.1.3. Java 8 + Tomcat 8</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#idp60">2.1.3.1. systemctl 启动脚本</a></span></dt><dt><span class="section"><a href="index.html#session">2.1.3.2. Session 共享</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#idp61">2.1.3.2.1. test session</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="index.html#firewall">2.1.4. 防火墙配置</a></span></dt><dt><span class="section"><a href="index.html#multiple-instances">2.1.5. 同时运行多实例</a></span></dt><dt><span class="section"><a href="index.html#test">2.1.6. Testing file</a></span></dt><dt><span class="section"><a href="index.html#mod_jk">2.1.7. mod_jk</a></span></dt><dt><span class="section"><a href="index.html#proxy_ajp">2.1.8. mod_proxy_ajp</a></span></dt><dt><span class="section"><a href="index.html#rewrite">2.1.9. RewriteEngine 连接 Tomcat</a></span></dt><dt><span class="section"><a href="index.html#idp62">2.1.10. SSL 双向认证</a></span></dt></dl></dd><dt><span class="section"><a href="conf.html">2.2. 配置 Tomcat 服务器</a></span></dt><dd><dl><dt><span class="section"><a href="conf.html#server.xml">2.2.1. server.xml</a></span></dt><dd><dl><dt><span class="section"><a href="conf.html#connector">2.2.1.1. Connector</a></span></dt><dd><dl><dt><span class="section"><a href="conf.html#https">2.2.1.1.1. HTTPS</a></span></dt><dt><span class="section"><a href="conf.html#compression">2.2.1.1.2. compression</a></span></dt><dt><span class="section"><a href="conf.html#useBodyEncodingForURI">2.2.1.1.3. useBodyEncodingForURI</a></span></dt><dt><span class="section"><a href="conf.html#idp63">2.2.1.1.4. 隐藏Tomcat版本信息</a></span></dt></dl></dd><dt><span class="section"><a href="conf.html#context">2.2.1.2. Context</a></span></dt><dd><dl><dt><span class="section"><a href="conf.html#idp64">2.2.1.2.1. 应用程序安全</a></span></dt><dt><span class="section"><a href="conf.html#idp65">2.2.1.2.2. JSESSIONID</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="conf.html#tomcat-users.xml">2.2.2. tomcat-users.xml</a></span></dt><dt><span class="section"><a href="conf.html#context.xml">2.2.3. context.xml</a></span></dt><dd><dl><dt><span class="section"><a href="conf.html#resources">2.2.3.1. Resources</a></span></dt><dt><span class="section"><a href="conf.html#idp66">2.2.3.2. session cookie</a></span></dt></dl></dd><dt><span class="section"><a href="conf.html#logging.properties">2.2.4. logging.properties</a></span></dt><dt><span class="section"><a href="conf.html#idp67">2.2.5. catalina.properties</a></span></dt></dl></dd><dt><span class="section"><a href="vhost.html">2.3. 虚拟主机配置</a></span></dt><dd><dl><dt><span class="section"><a href="vhost.html#idp68">2.3.1. 方案一</a></span></dt><dt><span class="section"><a href="vhost.html#idp69">2.3.2. 方案二</a></span></dt><dt><span class="section"><a href="vhost.html#alias">2.3.3. Alias 别名</a></span></dt><dt><span class="section"><a href="vhost.html#access_log">2.3.4. access_log</a></span></dt><dt><span class="section"><a href="vhost.html#context">2.3.5. Context 配置</a></span></dt><dt><span class="section"><a href="vhost.html#name">2.3.6. 主机绑定IP地址</a></span></dt></dl></dd><dt><span class="section"><a href="ssi.html">2.4. SSI</a></span></dt><dt><span class="section"><a href="logs.html">2.5. Logging 日志</a></span></dt><dd><dl><dt><span class="section"><a href="logs.html#log4j">2.5.1. 开启 debug 模式</a></span></dt><dt><span class="section"><a href="logs.html#idp70">2.5.2. 切割 catalina.out 日志</a></span></dt></dl></dd><dt><span class="section"><a href="script.html">2.6. Init.d Script</a></span></dt><dd><dl><dt><span class="section"><a href="script.html#idp71">2.6.1. Script 1</a></span></dt><dt><span class="section"><a href="script.html#idp72">2.6.2. Shell Script 2</a></span></dt></dl></dd></dl></div>
	

	

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="install"></a>2.1. Tomcat 安装与配置</h2></div></div></div>
	
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="tomcat6"></a>2.1.1. Tomcat 6</h3></div></div></div>
		
		<p>解压安装</p>
		<pre class="screen">
chmod +x jdk-6u1-linux-i586.bin
./jdk-6u1-linux-i586.bin
输入"yes"回车

mv jdk1.6.0_01 /usr/local/
ln -s /usr/local/jdk1.6.0_01/ /usr/local/java
		</pre>
		<p>/etc/profile.d/java.sh</p>
		<div class="example"><a id="idp159"></a><p class="title"><strong>例 2.1. /etc/profile.d/java.sh</strong></p><div class="example-contents">
			
			<pre class="screen">
################################################
### Java environment
################################################
export JAVA_HOME=/usr/local/java
export JRE_HOME=/usr/local/java/jre
export PATH=$PATH:/usr/local/java/bin:/usr/local/java/jre/bin
export CLASSPATH="./:/usr/local/java/lib:/usr/local/java/jre/lib:/usr/local/memcached/api/java"
export JAVA_OPTS="-Xms512m -Xmx1024m"
			</pre>
		</div></div><br class="example-break" />

		<p>下载binary解压到/usr/local/</p>
		<p>下载软件包</p>
		<pre class="screen">
wget http://archive.apache.org/dist/tomcat/tomcat-6/v6.0.13/bin/apache-tomcat-6.0.13.tar.gz
wget http://archive.apache.org/dist/tomcat/tomcat-connectors/native/tomcat-native-1.1.10-src.tar.gz
wget http://archive.apache.org/dist/tomcat/tomcat-connectors/jk/source/jk-1.2.23/tomcat-connectors-1.2.23-src.tar.gz
		</pre>
		<pre class="screen">
tar zxvf apache-tomcat-6.0.13.tar.gz
mv apache-tomcat-6.0.13 /usr/local/
ln -s /usr/local/apache-tomcat-6.0.13/ /usr/local/tomcat
		</pre>

		<p>tomcat-native</p>
		<pre class="screen">
tar zxvf tomcat-native-1.1.10-src.tar.gz
cd tomcat-native-1.1.10-src/jni/native
./configure --with-apr=/usr/local/apache/bin/apr-1-config --with-java-home=/usr/local/java/
make
make install
		</pre>

		<p>catalina.sh</p>
		<pre class="screen">
CATALINA_OPTS="-Djava.library.path=/usr/local/apr/lib"
JAVA_OPTS="-Xss128k -Xms128m -Xmx1024m -XX:PermSize=128M -XX:MaxPermSize=256m -XX:MaxNewSize=256m"
		</pre>
		<p>启动</p>
		<pre class="screen">
startup.sh
		</pre>

		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp56"></a>2.1.1.1. tomcat-native</h4></div></div></div>
			
			<pre class="screen">
			
cd /usr/local/tomcat-6.0.18/bin
tar zxvf tomcat-native.tar.gz
cd tomcat-native-1.1.14-src/jni/native
./configure --with-apr=/usr/local/apr --with-java-home=/usr/java/jdk1.6.0_11
make &amp;&amp; make install
			
			</pre>
		</div>

		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp57"></a>2.1.1.2. 启动脚本</h4></div></div></div>
			
			<div class="example"><a id="idp160"></a><p class="title"><strong>例 2.2. /etc/init.d/tomcat</strong></p><div class="example-contents">
				
				<pre class="screen">
				
# cat /etc/init.d/tomcat
#!/bin/bash
# description: Tomcat Start Stop Restart
# processname: tomcat
# chkconfig: 234 20 80

JAVA_HOME=/srv/java
CATALINA_HOME=/srv/apache-tomcat

# Source function library.
. /etc/init.d/functions

# Source networking configuration.
. /etc/sysconfig/network

if [ -f /etc/sysconfig/tomcat ]; then
        . /etc/sysconfig/tomcat
fi

prog=tomcat
lockfile=/var/lock/subsys/$prog
pidfile=${PIDFILE-/var/run/$prog.pid}
lockfile=${LOCKFILE-/var/lock/subsys/$prog}
RETVAL=0
OPTIONS="--pidfile=${pidfile}"

start(){
        # Start daemons.
        echo -n $"Starting $prog: "
        #daemon $prog $OPTIONS
	$CATALINA_HOME/bin/startup.sh
	RETVAL=$?
        echo
	[ $RETVAL -eq 0 ] &amp;&amp; touch $lockfile
	return $RETVAL

}

stop() {
	echo -n $"Stopping $prog: "
#	killproc -p ${pidfile} -d 10 $httpd
	$CATALINA_HOME/bin/shutdown.sh
	RETVAL=$?
	echo
	[ $RETVAL = 0 ] &amp;&amp; rm -f ${lockfile} ${pidfile}
}

case $1 in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        start
        stop
    ;;
esac
exit 0
				
				</pre>
			</div></div><br class="example-break" />
			<p>创建 /etc/init.d/tomcat 文件，复制并粘贴上面的启动脚本</p>
			<pre class="screen">
vim /etc/init.d/tomcat
chmod +x /etc/init.d/tomcat
chkconfig --add tomcat
chkconfig --level 234 tomcat on
chkconfig --list tomcat
			</pre>
		</div>
	</div>

	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="tomcat7"></a>2.1.2. Tomcat 7</h3></div></div></div>
		
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp58"></a>2.1.2.1. Server JRE</h4></div></div></div>
			
			<p>安装  Server JRE</p>
			<pre class="screen">
cd /usr/local/src/

tar zxvf server-jre-7u21-linux-x64.gz
mv jdk1.7.0_21 /srv/
ln -s /srv/jdk1.7.0_21 /srv/java
			</pre>
			<p>或者</p>
			<pre class="screen">
curl -sS https://raw.github.com/netkiller/shell/master/java/server-jre.sh | bash
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp59"></a>2.1.2.2. Tomcat</h4></div></div></div>
			
			<p>安装下面步骤安装Tomcat，注意不要使用root启动tomcat。这里使用www用户启动tomcat,这样的目的是让tomcat进程继承www用户权限。</p>
			<pre class="screen">
			
cd /usr/local/src/
wget http://ftp.cuhk.edu.hk/pub/packages/apache.org/tomcat/tomcat-7/v7.0.40/bin/apache-tomcat-7.0.40.tar.gz
tar zxvf apache-tomcat-7.0.40.tar.gz

mv apache-tomcat-7.0.40 /srv/
ln -s /srv/apache-tomcat-7.0.40 /srv/apache-tomcat
rm -rf /srv/apache-tomcat/webapps/*

cat &gt; /srv/apache-tomcat/bin/setenv.sh &lt;&lt;'EOF'
export JAVA_HOME=/srv/java
export JAVA_OPTS="-server -Xms512m -Xmx8192m  -XX:PermSize=64M -XX:MaxPermSize=512m"
export CATALINA_HOME=/srv/apache-tomcat
export CLASSPATH=$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$CATALINA_HOME/lib:
export PATH=$PATH:$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$CATALINA_HOME/bin:
EOF

cp /srv/apache-tomcat/conf/server.xml{,.original}

groupadd -g 80 www
adduser -o --home /srv --uid 80 --gid 80 -c "Web Application" www

chown www:www -R /srv/*

su - www -c "/srv/apache-tomcat/bin/startup.sh"
			
			</pre>
			<p>或者运行下面脚本快速安装</p>
			<pre class="screen">
curl -sS https://raw.github.com/netkiller/shell/master/apache/tomcat/install.sh | bash
			</pre>
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="tomcat8"></a>2.1.3. Java 8 + Tomcat 8</h3></div></div></div>
		
		<p>安装Java 8</p>
		<pre class="screen">
		
cd /usr/local/src/

tar zxf server-jre-8u20-linux-x64.gz 
mv jdk1.8.0_20 /srv/
ln -s /srv/jdk1.8.0_20 /srv/java

cat &gt;&gt; /etc/profile.d/java.sh &lt;&lt;'EOF'
export JAVA_HOME=/srv/java
export JAVA_OPTS="-server -Xms512m -Xmx8192m"
export CLASSPATH=$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$CATALINA_HOME/lib:
export PATH=$PATH:$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$CATALINA_HOME/bin:
EOF		
		
		</pre>
		<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[注意]" src="/graphics/note.png" /></td><th align="left">注意</th></tr><tr><td align="left" valign="top">
			<p>Java 8 取消了 PermSize 与 MaxPermSize 配置项"</p>
		</td></tr></table></div>
		<pre class="screen">
		
cd /usr/local/src/
wget http://ftp.cuhk.edu.hk/pub/packages/apache.org/tomcat/tomcat-8/v8.0.12/bin/apache-tomcat-8.0.12.tar.gz
tar zxf apache-tomcat-8.0.12.tar.gz 

mv apache-tomcat-8.0.12 /srv/
ln -s /srv/apache-tomcat-8.0.12 /srv/apache-tomcat
rm -rf /srv/apache-tomcat/webapps/*
cp /srv/apache-tomcat/conf/server.xml{,.original}

cat &gt; /srv/apache-tomcat/bin/setenv.sh &lt;&lt;'EOF'
export JAVA_HOME=/srv/java
export JAVA_OPTS="-server -Xms512m -Xmx8192m"
export CATALINA_HOME=/srv/apache-tomcat
export CLASSPATH=$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$CATALINA_HOME/lib:/srv/IngrianJCE/lib/ext/IngrianNAE-5.1.1.jar
export PATH=$PATH:$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$CATALINA_HOME/bin:
EOF
		
		</pre>
		<p>启动 Tomcat</p>
		<pre class="screen">
groupadd -g 80 www
adduser -o --home /www --uid 80 --gid 80 -c "Web Application" www

chown www:www -R /srv/apache-tomcat-*

su - www -c "/srv/apache-tomcat/bin/startup.sh"		
		</pre>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp60"></a>2.1.3.1. systemctl 启动脚本</h4></div></div></div>
			
			<pre class="screen">
curl -s https://raw.githubusercontent.com/oscm/shell/master/web/tomcat/systemctl.sh | bash
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="session"></a>2.1.3.2. Session 共享</h4></div></div></div>
			
			<pre class="screen">
$ git clone https://github.com/chexagon/redis-session-manager.git
$ cd redis-session-manager/
$ mvn package
$ ls target/redis-session-manager-with-dependencies-2.1.1-SNAPSHOT.jar 
redis-session-manager-with-dependencies-2.1.1-SNAPSHOT.jar

$ cp target/redis-session-manager-with-dependencies-2.1.1-SNAPSHOT.jar /srv/apache-tomcat/apache-tomcat-8.5.11/lib/
			</pre>
			<p>如果Redis是 127.0.0.1 配置 conf/context.xml 加入下面一行，</p>
			<pre class="screen">
			
&lt;Manager className="com.crimsonhexagon.rsm.redisson.SingleServerSessionManager" /&gt;			
			
			</pre>
			<p>完整的配置</p>
			<pre class="screen">
			
    &lt;Manager className="com.crimsonhexagon.rsm.redisson.SingleServerSessionManager"
	    endpoint="localhost:6379"
	    sessionKeyPrefix="JSESSIONID::"
	    saveOnChange="false"
	    forceSaveAfterRequest="false"
	    dirtyOnMutation="false"
	    ignorePattern=".*\\.(ico|png|gif|jpg|jpeg|swf|css|js)$"
	    connectionPoolSize="100"
	    database="16"
	    password="yourpassword"
	    timeout="60000"
	    pingTimeout="1000"
	    retryAttempts="20"
	    retryInterval="1000"
    /&gt;
			
			</pre>
			<div class="example"><a id="idp161"></a><p class="title"><strong>例 2.3. Example /srv/apache-tomcat/conf</strong></p><div class="example-contents">
				
				<pre class="screen">
				
cat context.xml
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
--&gt;
&lt;!-- The contents of this file will be loaded for each web application --&gt;
&lt;Context&gt;

    &lt;!-- Default set of monitored resources. If one of these changes, the    --&gt;
    &lt;!-- web application will be reloaded.                                   --&gt;
    &lt;WatchedResource&gt;WEB-INF/web.xml&lt;/WatchedResource&gt;
    &lt;WatchedResource&gt;${catalina.base}/conf/web.xml&lt;/WatchedResource&gt;

    &lt;!-- Uncomment this to disable session persistence across Tomcat restarts --&gt;
    &lt;!--
    &lt;Manager pathname="" /&gt;
    --&gt;
    &lt;Manager className="com.crimsonhexagon.rsm.redisson.SingleServerSessionManager"
	    endpoint="localhost:6379"
	    sessionKeyPrefix="JSESSIONID"
	    saveOnChange="false"
	    forceSaveAfterRequest="false"
	    dirtyOnMutation="false"
	    ignorePattern=".*\\.(ico|png|gif|jpg|jpeg|swf|css|js)$"
	    connectionPoolSize="100"
	    database="0"
	    password=""
	    timeout="60000"
	    pingTimeout="1000"
	    retryAttempts="20"
	    retryInterval="1000"
    /&gt;
&lt;/Context&gt;
				
				
				</pre>
			</div></div><br class="example-break" />
			<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp61"></a>2.1.3.2.1. test session</h5></div></div></div>
				
				<pre class="screen">
				
&lt;%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%&gt;  
&lt;!DOCTYPE html&gt;  
&lt;html&gt;  
&lt;head&gt;  
&lt;title&gt;set session&lt;/title&gt;  
&lt;/head&gt;  
&lt;body&gt;
  &lt;%= session.getId() %&gt;
  &lt;%  
    session.setAttribute("neo", "netkiller");   
  %&gt;  
&lt;/body&gt;  
&lt;/html&gt;				
				
				</pre>
				
				<pre class="screen">
				
&lt;%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%&gt;  
&lt;!DOCTYPE html&gt;  
&lt;html&gt;  
&lt;head&gt;  
&lt;title&gt;get session&lt;/title&gt;  
&lt;/head&gt;  
&lt;body&gt;  
  &lt;%= session.getId() %&gt;  
  &lt;br/&gt;
  &lt;br/&gt;  
  &lt;%=(String)session.getAttribute("neo")%&gt;  
  
&lt;/body&gt;  
&lt;/html&gt;
				
				</pre>
			</div>
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="firewall"></a>2.1.4. 防火墙配置</h3></div></div></div>
		
		<pre class="screen">
iptables -A INPUT -m state --state NEW -m tcp -p tcp --dport 8080 -j ACCEPT
		</pre>

		<p>80 跳转 8080 方案</p>
		<pre class="screen">
iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080
		</pre>
		<p>取消跳转</p>
		<pre class="screen">
iptables -t nat -D PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080
		</pre>
		<p>查看规则</p>
		<pre class="screen">
iptables -t nat -L
		</pre>
		<div class="example"><a id="idp162"></a><p class="title"><strong>例 2.4. tomcat firewall</strong></p><div class="example-contents">
			
			<p>下面是完整的例子，仅供参考，复制到 /etc/sysconfig/iptables 文件中，重启iptables即可生效。</p>
			<pre class="screen">
# cat /etc/sysconfig/iptables
# Generated by iptables-save v1.4.7 on Mon Jul 22 15:58:35 2013
*nat
:PREROUTING ACCEPT [7:847]
:POSTROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A PREROUTING -p tcp -m tcp --dport 80 -j REDIRECT --to-port 8080
COMMIT
# Completed on Mon Jul 22 15:58:35 2013
# Generated by iptables-save v1.4.7 on Mon Jul 22 15:58:35 2013
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [42303:3464247]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 8080 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
# Completed on Mon Jul 22 15:58:35 2013
			</pre>
		</div></div><br class="example-break" />
	</div>
	
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="multiple-instances"></a>2.1.5. 同时运行多实例</h3></div></div></div>
		
		<p>创建工作目录</p>
		<pre class="screen">
mkdir /srv/apache-tomcat
		</pre>
		<p>每个端口一个目录</p>
		<pre class="screen">
tar zxvf apache-tomcat-7.0.x.tar.gz
mv  apache-tomcat-7.0.x /srv/apache-tomcat/8080

tar zxvf apache-tomcat-7.0.x.tar.gz
mv  apache-tomcat-7.0.x /srv/apache-tomcat/9090
		</pre>
		<p>修改 Server port="8006" 与 Connector port="9090"端口，不要出现重复。</p>
		<pre class="screen">
		

&lt;Server port="8006" shutdown="SHUTDOWN"&gt;


 &lt;Connector port="9090" protocol="HTTP/1.1"
               connectionTimeout="20000"
               redirectPort="8443" /&gt;

&lt;!--
    &lt;Connector port="8009" protocol="AJP/1.3" redirectPort="8443" /&gt;
--&gt;
		
		</pre>
		<p>启动tomcat然后观察catalina.log日志文件，确认每个进程都正确启动。</p>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="test"></a>2.1.6. Testing file</h3></div></div></div>
		
		<p>创建测试文件</p>
		<span class="command"><strong>vim webapps/ROOT/index.jsp</strong></span>
		<pre class="screen">
		
&lt;%@ page contentType="text/html;charset=utf-8"%&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"&gt;
&lt;title&gt;helloworld!&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
&lt;h1&gt;
&lt;%="It works!"%&gt;
&lt;/h1&gt;
&lt;%
out.println("&lt;h3&gt;Hello World!&lt;/h3&gt;");
%&gt;
&lt;hr /&gt;
&lt;%=new java.util.Date()%&gt;
&lt;/body&gt;
&lt;/html&gt;
		
		</pre>
		<p>使用curl命令测试，测试结果类似下面结果。</p>
		<pre class="screen">
		
$ curl http://192.168.6.9/index.jsp

&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"&gt;
&lt;title&gt;helloworld!&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
&lt;h1&gt;
It works!
&lt;/h1&gt;
&lt;h3&gt;Hello World!&lt;/h3&gt;

&lt;hr /&gt;
Mon Jul 22 16:41:46 HKT 2013
&lt;/body&gt;
&lt;/html&gt;
		
		</pre>
	</div>

	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="mod_jk"></a>2.1.7. mod_jk</h3></div></div></div>
		
		<p>mod_jk 安装</p>
		<pre class="screen">
tar zxvf tomcat-connectors-1.2.23-src.tar.gz
cd tomcat-connectors-1.2.23-src/native/
./configure --with-apxs=/usr/local/apache/bin/apxs
make
make install
chmod 755 /usr/local/apache/modules/mod_jk.so
		</pre>
		<p>httpd.conf 尾部加入</p>
		<pre class="screen">
Include conf/mod_jk.conf
		</pre>
		<p>配置workers.properties</p>
		<span class="command"><strong>apache/conf/workers.properties</strong></span>
		<pre class="screen">
# Define 1 real worker using ajp13
worker.list=worker1
# Set properties for worker1 (ajp13)
worker.worker1.type=ajp13
worker.worker1.host=127.0.0.1
worker.worker1.port=8009
worker.worker1.lbfactor=1
worker.worker1.cachesize=128
worker.worker1.cache_timeout=600
worker.worker1.socket_keepalive=1
worker.worker1.reclycle_timeout=300
		</pre>

		<p>mod_jk.conf</p>
		<span class="command"><strong>apache/conf/mod_jk.conf</strong></span>
		<pre class="screen">
		
[chenjingfeng@d3010 Includes]$ cat mod_jk.conf
&lt;IfModule mod_jk.c&gt;
# Load mod_jk module
LoadModule jk_module            modules/mod_jk.so
# Where to find workers.properties
JkWorkersFile           /usr/local/apache/conf/workers.properties
# Where to put jk logs
JkLogFile               /usr/local/apache/logs/mod_jk.log
# Set the jk log level [debug/error/info]
JkLogLevel              error
# Select the log format
JkLogStampFormat "[%a %b %d %H:%M:%S %Y] "
# JkOptions indicate to send SSL KEY SIZE,
JkOptions     +ForwardKeySize +ForwardURICompat -ForwardDirectories
# JkRequestLogFormat set the request format
JkRequestLogFormat     "%w %V %T"
JkShmFile     /usr/local/apache2/logs/mod_jk.shm
# Send jsp,servlet for context * to worker named worker1
JkMount  /status/* worker1
JkMount  /*.jsp worker1
JkMount  /*.jsps worker1
JkMount  /*.do worker1
JkMount  /*Servlet worker1
JkMount  /jk/* worker1
&lt;/IfModule&gt;
		
		</pre>
		<p>分别测试apache,tomcat</p>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="proxy_ajp"></a>2.1.8. mod_proxy_ajp</h3></div></div></div>
		
		<p>包含虚拟主机配置文件</p>
		<span class="command"><strong># vi conf/httpd.conf</strong></span>
		<pre class="screen">
# Virtual hosts
Include conf/extra/httpd-vhosts.conf
		</pre>
		<p>虚拟主机中配置ProxyPass,ProxyPassReverse</p>
		<span class="command"><strong># vi conf/extra/httpd-vhosts.conf</strong></span>
		<pre class="screen">
		
&lt;VirtualHost *:80&gt;
    ServerName netkiller.8800.org
    ProxyPass /images !
	ProxyPass /css !
	ProxyPass /js !
    ProxyPass /ajp ajp://localhost:8009/ajp
    ProxyPassReverse /ajp ajp://localhost:8009/ajp
&lt;/VirtualHost&gt;
		
		</pre>
		<p>反向代理和均衡负载模块</p>
		<pre class="screen">
		
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_ajp_module modules/mod_proxy_ajp.so
LoadModule proxy_balancer_module modules/mod_proxy_balancer.so

ProxyPass /admin balancer://tomcatcluster/admin lbmethod=byrequests stickysession=JSESSIONID nofailover=Off timeout=5 maxattempts=3
ProxyPassReverse /admin balancer://tomcatcluster/admin

&lt;Proxy balancer://tomcatcluster&gt;
	BalancerMember ajp://localhost:8009 route=web1
	BalancerMember ajp://localhost:10009 smax=10 route=web2
	BalancerMember ajp://localhost:11009 route=web3
	BalancerMember ajp://localhost:12009 smax=10 route=web4
&lt;/Proxy&gt;
		
		</pre>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="rewrite"></a>2.1.9. RewriteEngine 连接 Tomcat</h3></div></div></div>
		
		<pre class="screen">
		
RewriteEngine On

RewriteRule ^/(.*) ajp://localhost:8009/ajp/$1 [P]
RewriteRule ^/(.*\.(jsp|do|sevlet)) ajp://localhost:8009/ajp/$1 [P]
		
		</pre>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="idp62"></a>2.1.10. SSL 双向认证</h3></div></div></div>
		
		<p>首先我并不建议使用 tomcat 实现SSL双向验证，这个工作可以交给 Web 服务器完成。但有些场景可能需要，可以参考下面例子。</p>
		<p>服务器端证书</p>
		<pre class="screen">
keytool -genkey -v -alias serverKey -dname "CN=localhost" -keyalg RSA -keypass xxxxxx -keystore server.ks -storepass xxxxxx
		</pre>
		<p>客户端证书</p>
		<pre class="screen">
keytool -genkey -v -alias clientKey -dname "CN=SomeOne" -keyalg RSA -keypass xxxxxx -keystore client.p12 -storepass xxxxxx -storetype PKCS12		
keytool -export -alias clientKey -file clientKey.cer -keystore client.p12 -storepass xxxxxx -storetype PKCS12
		</pre>
		<p>导入客户端证书</p>
		<pre class="screen">
keytool -import -v -alias clientKey -file clientKey.cer -keystore server.ks -storepass xxxxxx		
		</pre>
		<p>如果希望在 Windows 浏览器中访问，下导入证书方式，双击 client.p12 文件，安装提示导入</p>
		<p>配置 Tomcat ，编辑 server.xml 文件</p>
		<pre class="screen">
		
&lt;Connector port="8443" protocol="HTTP/1.1" SSLEnabled="true"
maxThreads="1024" scheme="https" secure="true"
clientAuth="true" sslProtocol="TLS"
keystoreFile="server.ks" keystorePass="xxxxxx"
truststoreFile="server.ks " truststorePass="xxxxxx" /&gt;
		
		</pre>
	</div>
</div>
	


	

	
	
	


</div><div xmlns="" id="disqus_thread"></div><script xmlns="">

var disqus_config = function () {
this.page.url = "http://www.netkiller.cn";  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = 'netkiller'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//netkiller.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script><noscript xmlns="">Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><br xmlns="" /><script xmlns="" type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=r5HG&amp;d=9mi5r_kkDC8uxG8HuY3p4-2qgeeVypAK9vMD-2P6BYM"></script><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="../nginx/faq.html">上一页</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="conf.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">1.6. FAQ </td><td width="20%" align="center"><a accesskey="h" href="../index.html">起始页</a></td><td width="40%" align="right" valign="top"> 2.2. 配置 Tomcat 服务器</td></tr></table></div><script xmlns="">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-11694057-1', 'auto');
  ga('send', 'pageview');

</script><script xmlns="" async="async">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?93967759a51cda79e49bf4e34d0b0f2c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script xmlns="" async="async">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script><script xmlns="" type="text/javascript" src="/js/q.js" async="async"></script></body></html>