<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Linux 系统与数据库安全</title><link rel="stylesheet" type="text/css" href="docbook.css"/><link rel="stylesheet" type="text/css" href="/journal/journal.css"/><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"/><meta name="description" content="Linux 系统安全问题"/><meta name="keywords" content="linux, mysql, security"/></head><body><section xml:lang="zh-cn" class="article" id="idp1"><div class="titlepage"><div><div><h2 class="title">Linux 系统与数据库安全</h2></div><div><h3 class="subtitle"><em>http://netkiller.github.io/journal/security.db.html</em></h3></div><div><div class="author"><h3 class="author"><span class="honorific">Mr</span>. <span class="firstname">Neo Chen</span> <span class="surname">(陈景峯)</span>, <span class="lineage">netkiller, BG7NYT</span></h3><div class="affiliation">
			<div class="address"><p><br/>
				<span class="country">中国</span><span class="state">广东省</span><span class="city">深圳市</span><span class="street">龙华新区民治街道溪山美地</span><br/>
				<span class="postcode">518131</span><br/>
				<span class="phone">+86 13113668890</span><br/>
				<br/>
				<code class="email">&lt;<a class="email" href="mailto:netkiller@msn.com">netkiller@msn.com</a>&gt;</code><br/>
			</p></div>
		</div></div></div><div><div class="legalnotice" id="legalnotice">
	<p class="legalnotice-title"><strong>版权声明</strong></p>
	<p>转载请与作者联系，转载时请务必标明文章原始出处和作者信息及本声明。</p>
	<table style="border: 0; " class="simplelist"><tr><td>
		<a class="ulink" href="http://creativecommons.org/licenses/by/3.0/" target="_top">
			<div><table style="border: 0; width: 180px; cellpadding: 0; cellspacing: 0;"><tr><td><img src="/images/by-nc-sa.png" width="180"/></td></tr></table></div>
		</a>
		</td><td>
			<table style="border: 0; " class="simplelist"><tr><td>
					文档出处:
				</td></tr><tr><td>
					<a class="ulink" href="http://netkiller.github.io/" target="_top">http://netkiller.github.io</a>
				</td></tr><tr><td>
					<a class="ulink" href="http://netkiller.sourceforge.net/" target="_top">http://netkiller.sourceforge.net</a>
				</td></tr></table>
		</td><td>
			<a class="ulink" href="/images/weixin.jpg" target="_top"><div><table style="border: 0; width: 80px; cellpadding: 0; cellspacing: 0;"><tr><td><img src="/images/weixin.jpg" width="80"/></td></tr></table></div></a>
		</td><td>
			<p>微信扫描二维码进入 Netkiller 微信订阅号 </p>
			<p>QQ群：128659835 请注明“读者”</p>
		</td></tr></table>
	<p/>
</div></div><div><div class="abstract"><div class="abstract-title">摘要</div>
			<p>Linux 系统安全问题</p>
		</div></div></div><hr/></div><div class="toc"><div class="toc-title">目录</div><ul class="toc"><li><span class="section"><a href="#idp4">1. 帐号安全</a></span><ul><li><span class="section"><a href="#idp2">1.1. Shell 安全</a></span></li><li><span class="section"><a href="#idp3">1.2. .history 文件</a></span></li></ul></li><li><span class="section"><a href="#idp5">2. 临时文件安全</a></span></li><li><span class="section"><a href="#idp6">3. 其他安全问题</a></span></li><li><span class="section"><a href="#idp7">4. 防火墙配置</a></span></li><li><span class="section"><a href="#idp20">5. 数据库安全</a></span><ul><li><span class="section"><a href="#idp8">5.1. 数据库程序安全</a></span></li><li><span class="section"><a href="#idp12">5.2. 数据库客户端安全</a></span><ul><li><span class="section"><a href="#idp9">5.2.1. bind-address</a></span></li><li><span class="section"><a href="#idp10">5.2.2. mysql 管理</a></span></li><li><span class="section"><a href="#idp11">5.2.3. ~/.mysql_history</a></span></li></ul></li><li><span class="section"><a href="#idp15">5.3. mysqldump 安全</a></span><ul><li><span class="section"><a href="#idp13">5.3.1. 数据备份</a></span></li><li><span class="section"><a href="#idp14">5.3.2. 数据恢复</a></span></li></ul></li><li><span class="section"><a href="#idp16">5.4. crontab 定时备份脚本于安全</a></span></li><li><span class="section"><a href="#idp17">5.5. 数据库归档文件</a></span></li><li><span class="section"><a href="#idp18">5.6. 开发与测试环境的数据库安全问题</a></span></li><li><span class="section"><a href="#idp19">5.7. 与数据库有关的服务器安全问题</a></span></li></ul></li></ul></div>
	

	<section class="section" id="idp4"><div class="titlepage"><div><div><h2 class="title" style="clear: both">1. 帐号安全</h2></div></div></div>
		
		<p>帐号权限安全</p>
		<section class="section" id="idp2"><div class="titlepage"><div><div><h3 class="title">1.1. Shell 安全</h3></div></div></div>
			
			<p>需求：限制用户权限,仅提供一些linux常用命令，用户监控linux系统于网络运行情况，不允许用户ssh登录后随意运行linux命令</p>
			<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
					<p>用户不能进入到Shell环境</p>
					<p>例如普通用户一旦登录web服务器可以看到web程序中的数据库配置</p>
				</li><li class="listitem">
					<p>用户可以了解OS工作状态如内存,cpu,网络等等</p>
					<p>例如：ping, tracepath, top, free, netstat</p>
				</li><li class="listitem">
					<p>可以查看系统部分日志</p>
					<p>例如：access.log, error.log, php-error.log ...</p>
				</li></ol></div>

			<p>使用mgmt替代bash</p>
			<pre class="screen">
			
#!/bin/bash
TITLE="Client"

#USER=$(whiptail --inputbox "User:" 8 60 --title "$TITLE" 3&gt;&amp;1 1&gt;&amp;2 2&gt;&amp;3)

#PASSWD=$(whiptail --title "$TITLE" --passwordbox "Passsword:" 8 60 3&gt;&amp;1 1&gt;&amp;2 2&gt;&amp;3)

COMMAND=$(whiptail --title "$TITLE" --menu "Administrator Tools" 22 50 10 \
"ping" "ping" \
"tracepath" "tracepath" \
"top" "top" \
"free" "free"  \
"ps" "ps"  \
"netstat" "netstat"  \
"lsof" "lsof"  \
"iftop" "iftop"  \
"log" "log" \
3&gt;&amp;1 1&gt;&amp;2 2&gt;&amp;3)

function option(){
OPTION=$(whiptail --inputbox "COMMAND-LINE Options: " 8 60 --title "$TITLE" 3&gt;&amp;1 1&gt;&amp;2 2&gt;&amp;3)
}

function weblog(){
LOG=$(whiptail --title "$TITLE" --menu "Logs" 22 50 8 \
"/var/log/messages" "message"  \
"/var/log/syslog" "syslog"  \
"/var/log/nginx/access.log" "access.log" \
"/var/log/nginx/error.log" "error.log"  \
3&gt;&amp;1 1&gt;&amp;2 2&gt;&amp;3)

}

case $COMMAND in
ping)
    option
    $COMMAND $OPTION
    ;;
tracepath)
    option
    $COMMAND $OPTION
    ;;
free)
    $COMMAND -m
    read
    ;;
top|iftop)
    $COMMAND
    ;;
log)
    weblog
    tail -f $LOG
    ;;
ps|lsof)
    option
    $COMMAND $OPTION
    read
    ;;
netstat)
    option
    $COMMAND $OPTION
    read
    ;;
*)
    exit $?
esac

			
			</pre>
			<p>Shell 启动文件，主要用户隐藏 /srv/sbin/mgmt 文件（针对菜鸟）</p>
			<pre class="screen">
			
$ cat shell.c
#include &lt;stdlib.h&gt;
main()
{
	for (;;){
		system("/srv/sbin/mgmt");
	}
}
			
			</pre>
			<p>编译.c文件</p>
			<pre class="screen">
gcc shell.c -o /bin/nsh
			</pre>
			<p>添加Shell到/etc/shells</p>
			<pre class="screen">
echo /bin/nsh &gt;&gt; /etc/shells
			</pre>
			<p>将用户shell更改为我们刚刚创建的nsh</p>
			<pre class="screen">
$ vim /etc/passwd

www:x:33:33:www:/var/www:/bin/nsh
 			</pre>
			<p>现在来作一个测试,如果正确应该现在为下面的TUI界面 </p>
			<pre class="screen">
			
ssh www@example.com

              ┌───────────────────┤ Client ├───────────────────┐
              │ Administrator Tools                            │
              │                                                │
              │               ping      ping                   │
              │               tracepath tracepath              │
              │               top       top                    │
              │               free      free                   │
              │               ps        ps                     │
              │               netstat   netstat                │
              │               lsof      lsof                   │
              │               iftop     iftop                  │
              │               log       log                    │
              │                                                │
              │                                                │
              │           &lt;Ok&gt;               &lt;Cancel&gt;          │
              │                                                │
              └────────────────────────────────────────────────┘
			
			</pre>
 			<div class="tip"><h3 class="title">提示</h3>
 				<p>这里采用的方式是给用户提供一个界面的方式，另外还有更好的方案,你可以些一个Shell的外壳，你需要实现</p>
				<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
						<p>与Shell相同的提示符</p>
					</li><li class="listitem">
						<p>提供TAB补齐</p>
					</li><li class="listitem">
						<p>上下光标键翻看历史命令，左右光标改变位置，Home/End 键到行首与行尾</p>
					</li><li class="listitem">
						<p>Ctrl+R 搜索， Ctrl+D 退出</p>
					</li><li class="listitem">
						<p>Ctrl+S,Ctrl+Q 等等</p>
					</li></ol></div>
				<p>流程</p>
				<pre class="screen">
用户输入 -&gt; 关键字过滤 -&gt; 放行
				</pre>
				<p>例如用户输入 cd / 经过过滤器后， cd /home/usr/</p>
				<p>例如用户输入 cd /aaa 经过过滤器后， cd /home/usr/aaa</p>
				<p>rm -rf /usr/local 提示拒绝等等</p>
				<p>我已经使用python实现上面的大部分功能（因为python受到很多限制）如果使用C可以100%实现，需要你的想想力了</p>
 			</div>
		</section>
		<section class="section" id="idp3"><div class="titlepage"><div><div><h3 class="title">1.2. .history 文件</h3></div></div></div>
			
			<p>SA的操作记录问题</p>
			<p>通过~/.bash_history文件记录系统管理员的操作记录，定制.bash_history格式</p>
			<pre class="screen">
HISTSIZE=1000
HISTFILESIZE=2000
HISTTIMEFORMAT="%Y-%m-%d-%H:%M:%S "
export HISTTIMEFORMAT
			</pre>
			<p>看看实际效果</p>
			<pre class="screen">
$ history | head
    1  2012-02-27-09:10:45 do-release-upgrade
    2  2012-02-27-09:10:45 vim /etc/network/interfaces
    3  2012-02-27-09:10:45 vi /etc/network/interfaces
    4  2012-02-27-09:10:45 ping www.163.com
			</pre>

		</section>

	</section>
	<section class="section" id="idp5"><div class="titlepage"><div><div><h2 class="title" style="clear: both">2. 临时文件安全</h2></div></div></div>
		
		<p>临时文件不应该有执行权限</p>
		<p>/tmp</p>
		<pre class="screen">
/dev/sda3 /tmp ext4 nosuid，noexec，nodev，rw 0 0
		</pre>
		<p>同时使用符号连接将/var/tmp 指向 /tmp</p>
		<p>/dev/shm</p>
		<pre class="screen">
none /dev/shm tmpfs defaults，nosuid，noexec，rw 0 0
		</pre>
	</section>
	<section class="section" id="idp6"><div class="titlepage"><div><div><h2 class="title" style="clear: both">3. 其他安全问题</h2></div></div></div>
		
		<p>/etc/sudoers</p>
		<pre class="screen">
		
Cmnd_Alias WEBMASTER = /usr/local/webserver/nginx/sbin/nginx, /usr/local/webserver/php/sbin/php-fpm, !/usr/local/webserver/mysql/bin/*
www localhost = NETWORKING, SERVICES, DELEGATING, PROCESSES, WEBMASTER

Cmnd_Alias Database = /usr/bin/mysqldump, /srv/mysql/bin/mysql, /u01/oracle/10.x.x/bin/sqlplus
oralce localhost = NETWORKING, SERVICES, DELEGATING, PROCESSES, WEBMASTER, Database
		
		</pre>
		<p>使用www用户测试登录，无误后修改SSH配置文件，禁止root登录。</p>
		<pre class="screen">
		
vim /etc/ssh/sshd_config
PermitRootLogin no
		
		</pre>
		<p>然后在测试从www su 到root</p>
	</section>
	<section class="section" id="idp7"><div class="titlepage"><div><div><h2 class="title" style="clear: both">4. 防火墙配置</h2></div></div></div>
		
		<p>封锁22等端口，避免相互跳转</p>
		<pre class="screen">
lokkit --enabled
iptables -F
iptables -A OUTPUT -p tcp -m multiport --dports 22,21,2049 -j REJECT
/etc/init.d/iptables save
iptables -L -n
		</pre>
		<p>web 服务器禁止使用ssh，作为跳板机</p>
		<p>用户将不能使用ssh命令登陆到其他电脑</p>
	</section>
	<section class="section" id="idp20"><div class="titlepage"><div><div><h2 class="title" style="clear: both">5. 数据库安全</h2></div></div></div>
		
		<p>我们以MySQL为例，讲解怎样控制DBA权限。稍加修改即可用于oracle等服务器</p>
		<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
				<p>DBA 没有系统SSH帐号，只有数据库帐号</p>
			</li><li class="listitem">
				<p>系统管理员只能有SSH系统帐号，没有数据库帐号</p>
			</li><li class="listitem">
				<p>DBA 可备份数据库，还原数据库指定的备份文件，但是接触不到备份文件</p>
			</li><li class="listitem">
				<p>DBA 有权重启数据库以及修复损坏库/表文件，通过工具完成，而不是登录SSH运行命令</p>
			</li></ol></div>
		<section class="section" id="idp8"><div class="titlepage"><div><div><h3 class="title">5.1. 数据库程序安全</h3></div></div></div>
			
			<p>rpm, deb 等等包安装mysql后默认权限是 755</p>
			<pre class="screen">
$ ll /usr/bin/mysql*
-rwxr-xr-x 1 root root  132132 2012-02-28 01:33 /usr/bin/mysql*
-rwxr-xr-x 1 root root  111572 2012-02-28 01:31 /usr/bin/mysqlaccess*
-rwxr-xr-x 1 root root   32468 2012-02-28 01:33 /usr/bin/mysqladmin*
-rwxr-xr-x 1 root root 2030768 2011-09-14 23:04 /usr/bin/mysql-admin*
lrwxrwxrwx 1 root root      10 2012-02-28 01:33 /usr/bin/mysqlanalyze -&gt; mysqlcheck*
-rwxr-xr-x 1 root root  147288 2012-02-28 01:33 /usr/bin/mysqlbinlog*
-rwxr-xr-x 1 root root   12006 2012-02-28 01:31 /usr/bin/mysqlbug*
-rwxr-xr-x 1 root root   24940 2012-02-28 01:33 /usr/bin/mysqlcheck*
-rwxr-xr-x 1 root root  451016 2012-02-28 01:33 /usr/bin/mysql_client_test*
-rwxr-xr-x 1 root root 7246484 2012-02-28 01:33 /usr/bin/mysql_client_test_embedded*
-rwxr-xr-x 1 root root    4245 2012-02-28 01:31 /usr/bin/mysql_convert_table_format*
-rwxr-xr-x 1 root root   23943 2012-02-28 01:31 /usr/bin/mysqld_multi*
-rwxr-xr-x 1 root root   16642 2012-02-28 01:32 /usr/bin/mysqld_safe*
-rwxr-xr-x 1 root root  101636 2012-02-28 01:33 /usr/bin/mysqldump*
-rwxr-xr-x 1 root root    7402 2012-02-28 01:31 /usr/bin/mysqldumpslow*
-rwxr-xr-x 1 root root    3315 2012-02-28 01:31 /usr/bin/mysql_find_rows*
-rwxr-xr-x 1 root root    1261 2012-02-28 01:31 /usr/bin/mysql_fix_extensions*
-rwxr-xr-x 1 root root    5834 2012-02-28 01:31 /usr/bin/mysql_fix_privilege_tables*
-rwxr-xr-x 1 root root   32477 2012-02-28 01:31 /usr/bin/mysqlhotcopy*
-rwxr-xr-x 1 root root   24584 2012-02-28 01:33 /usr/bin/mysqlimport*
-rwxr-xr-x 1 root root   14657 2012-02-28 01:31 /usr/bin/mysql_install_db*
lrwxrwxrwx 1 root root      10 2012-02-28 01:33 /usr/bin/mysqloptimize -&gt; mysqlcheck*
-rwxr-xr-x 1 root root 2006884 2011-09-14 23:04 /usr/bin/mysql-query-browser*
lrwxrwxrwx 1 root root      10 2012-02-28 01:33 /usr/bin/mysqlrepair -&gt; mysqlcheck*
-rwxr-xr-x 1 root root   39016 2012-02-28 01:32 /usr/bin/mysqlreport*
-rwxr-xr-x 1 root root    8066 2012-02-28 01:31 /usr/bin/mysql_secure_installation*
-rwxr-xr-x 1 root root   17473 2012-02-28 01:31 /usr/bin/mysql_setpermission*
-rwxr-xr-x 1 root root   23716 2012-02-28 01:33 /usr/bin/mysqlshow*
-rwxr-xr-x 1 root root   45884 2012-02-28 01:33 /usr/bin/mysqlslap*
-rwxr-xr-x 1 root root  208148 2012-02-28 01:33 /usr/bin/mysqltest*
-rwxr-xr-x 1 root root 6960852 2012-02-28 01:33 /usr/bin/mysqltest_embedded*
-rwxr-xr-x 1 root root 1334028 2012-02-28 01:33 /usr/bin/mysql_tzinfo_to_sql*
-rwxr-xr-x 1 root root   64728 2012-02-28 01:33 /usr/bin/mysql_upgrade*
-rwxr-xr-x 1 root root  149836 2012-02-28 01:33 /usr/bin/mysql_waitpid*
-rwxr-xr-x 1 root root    2108 2012-02-22 01:28 /usr/bin/mysql-workbench*
-rwxr-xr-x 1 root root 9885312 2012-02-22 01:29 /usr/bin/mysql-workbench-bin*
-rwxr-xr-x 1 root root    3888 2012-02-28 01:31 /usr/bin/mysql_zap*

			</pre>
			<p>从安全角度考虑我们需要如下更改</p>
			<pre class="screen">
chown mysql:mysql /usr/bin/mysql*
chmod 700 /usr/bin/mysql*
			</pre>
			<p>mysql用户是DBA专用用户</p>
		</section>
		<section class="section" id="idp12"><div class="titlepage"><div><div><h3 class="title">5.2. 数据库客户端安全</h3></div></div></div>
			
			<p>DBA不需要通过SSH登录数据库服务器，然后运行mysql/sqlplus在登录数据库</p>
			<section class="section" id="idp9"><div class="titlepage"><div><div><h4 class="title">5.2.1. bind-address</h4></div></div></div>
				
				<p>如果web与database 在一台机器上</p>
				<pre class="screen">
bind-address = 127.0.0.1
				</pre>
			</section>
			<section class="section" id="idp10"><div class="titlepage"><div><div><h4 class="title">5.2.2. mysql 管理</h4></div></div></div>
				
				<pre class="screen">
				
$ cat ../database/mysqltui
#!/bin/bash
TITLE="MySQL Client"

HOST=$(whiptail --title "$TITLE" --menu "MySQL Host" 22 50 8 \
"127.0.0.1" "localhost" \
"172.16.0.1" "MySQL Master" \
"172.16.0.2" "MySQL Slave 1" \
"172.16.0.3" "MySQL Slave 2"  \
3&gt;&amp;1 1&gt;&amp;2 2&gt;&amp;3)



USER=$(whiptail --inputbox "MySQL User:" 8 60 --title "$TITLE" 3&gt;&amp;1 1&gt;&amp;2 2&gt;&amp;3)

PASSWD=$(whiptail --title "$TITLE" --passwordbox "MySQL Password:" 8 60 3&gt;&amp;1 1&gt;&amp;2 2&gt;&amp;3)

#DATABASE=$(mysqlshow -h$HOST -u$USER | egrep -o "|\w(.*)\w|" | grep -v "Databases" |awk '{print "\""$1"\" \""$1"\""}')
#DATABASE=$(mysqlshow -h$HOST -u$USER | egrep -o "|\w(.*)\w|" | grep -v "Databases" |awk "{print \"$1\" \"$1\"}")

#DB=$(whiptail --title "$TITLE" --menu "MySQL DATABASE" 22 50 8 $DATABASE  3&gt;&amp;1 1&gt;&amp;2 2&gt;&amp;3)

DATABASE=$(whiptail --inputbox "MySQL Database:" 8 60 --title "$TITLE" 3&gt;&amp;1 1&gt;&amp;2 2&gt;&amp;3)

echo $HOST $USER $PASSWD $DATABASE

mysql -h$HOST -u$USER -p$PASSWD $DATABASE

				
				</pre>


				<p/>
				<pre class="screen">
				
             ┌───┤ MySQL Adminstrator ├───┐
             │ Menu                       │
             │                            │
             │       1 MySQL Manager      │
             │       2 MySQL Backup       │
             │       2 MySQL Restore      │
             │                            │
             │                            │
             │    &lt;Ok&gt;        &lt;Cancel&gt;    │
             │                            │
             └────────────────────────────┘
				
				</pre>
				<pre class="screen">
				
        ┌────────┤ MySQL Adminstrator ├────────┐
        │ Database Host                        │
        │                                      │
        │        127.0.0.1  localhost          │
        │        172.16.0.1 mysql master       │
        │        172.16.0.2 mysql slave        │
        │                                      │
        │       &lt;Ok&gt;           &lt;Cancel&gt;        │
        │                                      │
        └──────────────────────────────────────┘
				
				</pre>
				<p>/etc/php5/fpm/pool.d/www.conf</p>
				<pre class="screen">
				
        ┌────────┤ MySQL Adminstrator ├────────┐
        │ User                                 │
        │                                      │
        │ root________________________________ │
        │                                      │
        │       &lt;Ok&gt;           &lt;Cancel&gt;        │
        │                                      │
        └──────────────────────────────────────┘

        ┌────────┤ MySQL Adminstrator ├────────┐
        │ Password                             │
        │                                      │
        │ ****________________________________ │
        │                                      │
        │       &lt;Ok&gt;           &lt;Cancel&gt;        │
        │                                      │
        └──────────────────────────────────────┘
				
				</pre>
				<p>进入mysql客户端</p>
				<pre class="screen">
				
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 503
Server version: 5.1.58-1ubuntu1 (Ubuntu)

Copyright (c) 2000, 2010, Oracle and/or its affiliates. All rights reserved.
This software comes with ABSOLUTELY NO WARRANTY. This is free software,
and you are welcome to modify and redistribute it under the GPL v2 license

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql&gt;
				
				</pre>
				<div class="note"><h3 class="title">安全提示</h3>
					
					<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
							<p>从安全角度看，你可以去掉输入密码的过程。在终端提示符下输入</p>
							<p>Enter password:</p>
						</li><li class="listitem">
							<p>还可以写入～/.my.conf文件</p>
							<p>这样ssh mysql@example.com的时候输入第一道密码，然后进入mysql不需要输入密码</p>
						</li><li class="listitem">
							<p>如果需要输入密码对话到建议删除.bash_history</p>
							<p>rm -rf .bash_history</p>
							<p>ln -s /dev/null .bash_history</p>
						</li></ol></div>
				</div>
			</section>

			<section class="section" id="idp11"><div class="titlepage"><div><div><h4 class="title">5.2.3. ~/.mysql_history</h4></div></div></div>
				
				<p>通过~/.mysql_history文件记录DBA操作记录</p>
				<p>插入时间点，在~/.bashrc中加入下面命令</p>
				<pre class="screen">
				
cat &gt;&gt; ~/.bashrc &lt;&lt;EOD
echo `date` &gt;&gt; ~/.mysql_history
EOD
				
				</pre>
				<pre class="screen">
$ tail ~/.bashrc
echo `date` &gt;&gt; ~/.mysql_history
				</pre>
				<p>查看实际效果</p>
				<pre class="screen">
$ tail ~/.mysql_history
EXPLAIN SELECT * FROM stuff where id=3 \G
EXPLAIN SELECT * FROM stuff where id='3' \G
EXPLAIN SELECT * FROM stuff where id='2' \G
Mon Feb 27 09:15:18 CST 2012
EXPLAIN SELECT * FROM stuff where id='2' and created = '2012-02-01' \G
EXPLAIN SELECT * FROM stuff where id='1' and created = '2012-02-01' \G
EXPLAIN SELECT * FROM stuff where id='3' and created = '2012-02-01' \G
EXPLAIN SELECT * FROM stuff where id='2' and created = '2012-02-01' \G
EXPLAIN SELECT * FROM stuff where id='2' or created = '2012-02-01' \G
EXPLAIN SELECT * FROM stuff where id='2' and created = '2012-02-01' \G
Mon Feb 27 11:48:37 CST 2012
				</pre>
			</section>
		</section>
		<section class="section" id="idp15"><div class="titlepage"><div><div><h3 class="title">5.3. mysqldump 安全</h3></div></div></div>
			
			<section class="section" id="idp13"><div class="titlepage"><div><div><h4 class="title">5.3.1. 数据备份</h4></div></div></div>
				
				<pre class="screen">
				
MySQL Client
             ┌───┤ MySQL Adminstrator ├───┐
             │ Menu                       │
             │                            │
             │       1 MySQL Manager      │
             │       2 MySQL Backup       │
             │       2 MySQL Restore      │
             │                            │
             │                            │
             │    &lt;Ok&gt;        &lt;Cancel&gt;    │
             │                            │
             └────────────────────────────┘
				
				</pre>

				<pre class="screen">
				
MySQL Client
        ┌────────┤ MySQL Adminstrator ├────────┐
        │ Database Host                        │
        │                                      │
        │        127.0.0.1  localhost          │
        │        172.16.0.1 mysql master       │
        │        172.16.0.2 mysql slave        │
        │                                      │
        │       &lt;Ok&gt;           &lt;Cancel&gt;        │
        │                                      │
        └──────────────────────────────────────┘
				
				</pre>
				<pre class="screen">
				

        ┌────────┤ MySQL Adminstrator ├────────┐
        │ User                                 │
        │                                      │
        │ root________________________________ │
        │                                      │
        │       &lt;Ok&gt;           &lt;Cancel&gt;        │
        │                                      │
        └──────────────────────────────────────┘

        ┌────────┤ MySQL Adminstrator ├────────┐
        │ Password                             │
        │                                      │
        │ ****________________________________ │
        │                                      │
        │       &lt;Ok&gt;           &lt;Cancel&gt;        │
        │                                      │
        └──────────────────────────────────────┘
				
				</pre>

				<pre class="screen">
				

        ┌────────┤ MySQL Adminstrator ├────────┐
        │ Backup File Name                     │
        │                                      │
        │ 2010-12-12.01:00:00_________________ │
        │                                      │
        │       &lt;Ok&gt;           &lt;Cancel&gt;        │
        │                                      │
        └──────────────────────────────────────┘
				
				</pre>
				<pre class="screen">
				

        ┌────────┤ MySQL Adminstrator ├────────┐
        │                                      │
        │ Backup?                              │
        │                                      │
        │                                      │
        │        &lt;Yes&gt;           &lt;No&gt;          │
        │                                      │
        └──────────────────────────────────────┘
				
				</pre>

			</section>
			<section class="section" id="idp14"><div class="titlepage"><div><div><h4 class="title">5.3.2. 数据恢复</h4></div></div></div>
				
				<p/>

				<pre class="screen">
				
MySQL Client
             ┌───┤ MySQL Adminstrator ├───┐
             │ Menu                       │
             │                            │
             │       1 MySQL Manager      │
             │       2 MySQL Backup       │
             │       2 MySQL Restore      │
             │                            │
             │                            │
             │    &lt;Ok&gt;        &lt;Cancel&gt;    │
             │                            │
             └────────────────────────────┘
				
				</pre>
				<pre class="screen">
				
        ┌────────┤ MySQL Adminstrator ├────────┐
        │ Database Host                        │
        │                                      │
        │        127.0.0.1  localhost          │
        │        172.16.0.1 mysql master       │
        │        172.16.0.2 mysql slave        │
        │                                      │
        │       &lt;Ok&gt;           &lt;Cancel&gt;        │
        │                                      │
        └──────────────────────────────────────┘
				
				</pre>
				<p/>
				<pre class="screen">
				
        ┌────────┤ MySQL Adminstrator ├────────┐
        │ Backup History                       │
        │                                      │
        │        1  2010-12-03 03:00:00        │
        │        2  2012-01-01 02:00:00        │
        │        3  2012-02-01 02:00:00        │
        │                                      │
        │       &lt;Ok&gt;           &lt;Cancel&gt;        │
        │                                      │
        └──────────────────────────────────────┘
				
				</pre>
				<pre class="screen">
				
        ┌────────┤ MySQL Adminstrator ├────────┐
        │ User                                 │
        │                                      │
        │ root________________________________ │
        │                                      │
        │       &lt;Ok&gt;           &lt;Cancel&gt;        │
        │                                      │
        └──────────────────────────────────────┘

        ┌────────┤ MySQL Adminstrator ├────────┐
        │ Password                             │
        │                                      │
        │ ****________________________________ │
        │                                      │
        │       &lt;Ok&gt;           &lt;Cancel&gt;        │
        │                                      │
        └──────────────────────────────────────┘
				
				</pre>
				<pre class="screen">
				
        ┌────────┤ MySQL Adminstrator ├────────┐
        │                                      │
        │ Restore?                             │
        │                                      │
        │                                      │
        │        &lt;Yes&gt;           &lt;No&gt;          │
        │                                      │
        └──────────────────────────────────────┘
				
				</pre>
			</section>
		</section>
		<section class="section" id="idp16"><div class="titlepage"><div><div><h3 class="title">5.4. crontab 定时备份脚本于安全</h3></div></div></div>
			
			<p>网上备份脚本很多，但考虑都不周全。</p>
			<p>这里增加了 umask 0077 保证创建备份文件只能是创建者跟root可以访问，其他用户没有权限，保证了备份档案的安全。</p>
			<p>find $BACKUP_DIR -type f -mtime +$COPIES -delete 是负责备份的份数管理, 过期数据定时删除</p>
			<p>创建专用的备份帐号</p>
			<pre class="screen">
grant select, lock tables on *.* to 'backup'@'192.168.1.200' identified by "123456";
			</pre>
			<p>crontab 备份脚本</p>
			<pre class="screen">
			
# cat /srv/bin/backup

#!/bin/bash
###################################
# $Id: security.db.xml 650 2013-07-24 10:04:58Z netkiller $
# Author: netkiller@msn.com
# Home: http://netkiller.github.com
###################################
BACKUP_HOST="localhost"
BACKUP_USER="backup"
BACKUP_PASS=""
BACKUP_DIR=/opt/backup
BACKUP_DBNAME="test neo"
#Number of copies
COPIES=7
####################################
MYSQLDUMP="mysqldump"
#TIMEPOINT=$(date -u +%Y-%m-%d)
TIMEPOINT=$(date -u +%Y-%m-%d.%H:%M:%S)
MYSQLDUMP_OPTS="-h $BACKUP_HOST -u$BACKUP_USER -p$BACKUP_PASS"
####################################
umask 0077
test ! -d "$BACKUP_DIR" &amp;&amp; mkdir -p "$BACKUP_DIR"
test ! -w $BACKUP_DIR &amp;&amp; echo "Error: $BACKUP_DIR is un-writeable." &amp;&amp; exit 0

for dbname in $BACKUP_DBNAME
do
    test ! -d "$BACKUP_DIR/$dbname" &amp;&amp; mkdir -p "$BACKUP_DIR/$dbname"

    $MYSQLDUMP $MYSQLDUMP_OPTS $dbname | gzip &gt; $BACKUP_DIR/$dbname/$dbname.$TIMEPOINT.sql.gz
done
find $BACKUP_DIR -type f -mtime +$COPIES -delete
			
			</pre>
			<p>/srv/bin/backup 安全也至关重要，否则会泄漏备份用户的密码</p>
			<pre class="screen">
# chown mysql:mysql /srv/bin/backup
# chmod 500 /srv/bin/backup
			</pre>
			<p>mysqldump 的安全</p>
			<pre class="screen">
# chown 700 /usr/bin/mysqldump
			</pre>
		</section>
		<section class="section" id="idp17"><div class="titlepage"><div><div><h3 class="title">5.5. 数据库归档文件</h3></div></div></div>
			
			<p>一般数据库服务器上可以保留一周的备份数据，历史数据需要保存到服务器以外的带库或者阵列柜中，怎么样保证这些数据的安全呢？ 我们采用下面方式</p>
			<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
					<p>制作PGP/GPG密钥，密钥放置在数据库服务器上，证书做好备份，否则一旦丢失，将无法在将备份文件恢复</p>
				</li><li class="listitem">
					<p>数据库备份后，首先进行压缩处理</p>
				</li><li class="listitem">
					<p>然后使用公钥证书进行GPG/PGP数据加密</p>
				</li><li class="listitem">
					<p>这时可以放心的将备份数据库搬出数据库服务器到带库或磁盘阵列柜中</p>
				</li></ol></div>
			<p>恢复数据，将数据库备份文件复制到该数据库服务器，然后用私钥解密备份文件，再恢复到数据库到中</p>
		</section>
		<section class="section" id="idp18"><div class="titlepage"><div><div><h3 class="title">5.6. 开发与测试环境的数据库安全问题</h3></div></div></div>
			
			<p>有时候需要将生产环境的数据复制到开发环境上，例如，测试的时候，重现bug需要真实数据，开发环境的模拟数据无法满足要求，这时需要将生产环境的数据拉到测试或开发环境。如果保证数据的安全非常重要。</p>
			<p>最有效的手段是数据混淆，将重要的数据进行混淆扰乱顺序等等</p>
			<p>扰乱手段有</p>
			<div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
				颠倒顺序
				</li><li class="listitem">
				曾加干扰词
				</li><li class="listitem">
				重置或替换数据，例如密码可以全部改为test (update user set passwd='test')
				</li><li class="listitem">
				拼装数据 如 （131，137，135，133，139，138，168）后面加8位随机数
				</li></ol></div>
		</section>
		<section class="section" id="idp19"><div class="titlepage"><div><div><h3 class="title">5.7. 与数据库有关的服务器安全问题</h3></div></div></div>
			
			<p>其他服务器不能安装mysql客户端与mysqldump备份工具</p>
			<p>例如：web服务器只能通过php/jdbc/odbc等链接mysql数据库,
web服务器卸载 mysql，mysqldump工具，防止用户登录查询以及将数据库远程备份，然后通过web下载数据库</p>
			<pre class="screen">
			
# adduser www
# passwd www
# chmod 500 -R /usr/local/webserver/mysql/bin/*
# chown root:root -R /usr/local/webserver/mysql/bin/*
			
			</pre>

		</section>

	</section>
</section><div xmlns="" id="disqus_thread"/><script xmlns="">

var disqus_config = function () {
this.page.url = "http://www.netkiller.cn";  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = 'netkiller'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//netkiller.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script><noscript xmlns="">Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><br xmlns=""/><script xmlns="" type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=r5HG&amp;d=9mi5r_kkDC8uxG8HuY3p4-2qgeeVypAK9vMD-2P6BYM"/></body></html>