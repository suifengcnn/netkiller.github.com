<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>1.3. Network Authentication</title><link rel="stylesheet" type="text/css" href="..//docbook.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><meta name="keywords" content="Sniffer, Scanner, Vulnerability, Penetration, nmap, tcpdump, sqlmap, Nessus, Backtrack" /><link rel="home" href="../index.html" title="Netkiller Security 手札" /><link rel="up" href="index.html" title="第 1 章 Authentication" /><link rel="prev" href="pam.html" title="1.2. PAM 插件认证" /><link rel="next" href="../sniffer.html" title="第 2 章 Sniffer" /></head><body><a xmlns="" href="http://www.netkiller.cn/">Home</a> |
		<a xmlns="" href="http://netkiller.github.io/">简体中文</a> |
	    <a xmlns="" href="http://netkiller.sourceforge.net/">繁体中文</a> |
	    <a xmlns="" href="/journal/index.html">杂文</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/donations.html">打赏(Donations)</a> |
	    <a xmlns="" href="http://netkiller-github-com.iteye.com/">ITEYE 博客</a> |
	    <a xmlns="" href="http://my.oschina.net/neochen/">OSChina 博客</a> |
	    <a xmlns="" href="https://www.facebook.com/bg7nyt">Facebook</a> |
	    <a xmlns="" href="http://cn.linkedin.com/in/netkiller/">Linkedin</a> |
	    <a xmlns="" href="https://zhuanlan.zhihu.com/netkiller">知乎专栏</a> |
	    <a xmlns="" href="/search.html">Search</a> |
		<a xmlns="" href="mailto:netkiller@msn.com">Email</a><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">1.3. Network Authentication</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="pam.html">上一页</a> </td><th width="60%" align="center">第 1 章 Authentication</th><td width="20%" align="right"> <a accesskey="n" href="../sniffer.html">下一页</a></td></tr></table><hr /></div><table xmlns=""><tr><td><iframe src="http://ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=watch&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="http://ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=fork&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="http://ghbtns.com/github-btn.html?user=netkiller&amp;type=follow&amp;count=true&amp;size=large" height="30" width="240" frameborder="0" scrolling="0" style="width:240px; height: 30px;" allowTransparency="true"></iframe></td></tr></table><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="auth"></a>1.3. Network Authentication</h2></div></div></div>
		

		
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="nis"></a>1.3.1. Network Information Service (NIS)</h3></div></div></div>
	
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nis.install"></a>1.3.1.1. 安装NIS服务器</h4></div></div></div>
		
		<div class="procedure"><a id="idp91"></a><p class="title"><strong>过程 1.1. 安装NIS服务器</strong></p><ol class="procedure" type="1"><li class="step">
				<p>ypserv</p>
				<pre class="screen">
				
# yum install ypserv -y
				
				</pre>
			</li><li class="step">
				<p>/etc/hosts</p>
				<pre class="screen">
				
[root@nis ~]# hostname nis.example.com				
[root@nis ~]# echo "192.168.3.5 nis.example.com" &gt;&gt; /etc/hosts
[root@nis ~]# cat /etc/hosts
# Do not remove the following line, or various programs
# that require network functionality will fail.
127.0.0.1 datacenter.example.com datacenter localhost.localdomain localhost
::1 localhost6.localdomain6 localhost6
127.0.0.1 kerberos.example.com
192.168.3.5 nis.example.com
				
				</pre>
			</li><li class="step">
				<p>设置NIS域名</p>
				<pre class="screen">
				
# nisdomainname example.com
# nisdomainname
example.com
				
				</pre>
				<p>加入 /etc/rc.local 开机脚本</p>
				<pre class="screen">
				
# echo '/bin/nisdomainname example.com' &gt;&gt; /etc/rc.local
# echo 'NISDOMAIN=example.com' &gt;&gt; /etc/sysconfig/network
				
				</pre>
			</li><li class="step">
				<p>设置/etc/ypserv.conf主配置文件</p>
				<p>
				</p>
				<pre class="screen">
				
# vim /etc/ypserv.conf

127.0.0.0/255.255.255.0 : * : * : none
192.168.3.0/255.255.255.0 : * : * : none
* : * : * : deny
				
				</pre>
			</li><li class="step">
				<p>创建 /var/yp/securenets 文件</p>
				<p>securenets 安全配置文件</p>
				<pre class="screen">
				
# vim /var/yp/securenets
host 127.0.0.1
255.255.255.0 192.168.3.0
				
				</pre>
			</li><li class="step">
				<p>启动NIS服务器</p>
				<p>NIS服务器需要portmap服务的支持，并且需要启动ypserv和yppasswdd两个服务</p>
				<pre class="screen">
				
[root@nis ~]# service portmap status
portmap (pid 2336)
is running...
[root@nis ~]# service ypserv start
Starting YP
server services: [ OK ]
[root@nis ~]# service yppasswdd start
Starting YP passwd service: [ OK ]
				
				</pre>
			</li><li class="step">
				<p>构建NIS数据库</p>
				<p>32bit: /usr/lib/yp/ypinit -m</p>
				<p>64bit: /usr/lib64/yp/ypinit -m</p>
				<pre class="screen">
				
[root@nis ~]# /usr/lib64/yp/ypinit -m

At this point, we have to construct a list of the hosts which will run NIS
servers.  nis.example.com is in the list of NIS server hosts.  Please continue to add
the names for the other hosts, one per line.  When you are done with the
list, type a &lt;control D&gt;.
        next host to add:  nis.example.com
        next host to add:
        next host to add:
The current list of NIS servers looks like this:

nis.example.com


Is this correct?  [y/n: y]
We need a few minutes to build the databases...
Building /var/yp/example.com/ypservers...
Running /var/yp/Makefile...
gmake[1]: Entering directory `/var/yp/example.com'
Updating passwd.byname...
Updating passwd.byuid...
Updating group.byname...
Updating group.bygid...
Updating hosts.byname...
Updating hosts.byaddr...
Updating rpc.byname...
Updating rpc.bynumber...
Updating services.byname...
Updating services.byservicename...
Updating netid.byname...
Updating protocols.bynumber...
Updating protocols.byname...
Updating mail.aliases...
gmake[1]: Leaving directory `/var/yp/example.com'

nis.example.com has been set up as a NIS master server.

Now you can run ypinit -s nis.example.com on all slave server.

				
				</pre>
				<p>检查</p>
				<pre class="screen">
				
# ls /var/yp/
binding example.com Makefile nicknames securenets ypservers				
				
				</pre>
			</li><li class="step">
				<p>Service</p>
				<pre class="screen">
				
[root@datacenter ~]# chkconfig --list | grep yp
ypbind          0:off   1:off   2:off   3:off   4:off   5:off   6:off
yppasswdd       0:off   1:off   2:off   3:off   4:off   5:off   6:off
ypserv          0:off   1:off   2:off   3:off   4:off   5:off   6:off
ypxfrd          0:off   1:off   2:off   3:off   4:off   5:off   6:off

[root@nis ~]# chkconfig ypserv on
[root@nis ~]# chkconfig yppasswdd on
				
				</pre>
			</li></ol></div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nis.server.slave"></a>1.3.1.2. Slave NIS Server</h4></div></div></div>
		
		<p>Now you can run ypinit -s nis.example.com on all slave server.
		</p>
		<pre class="screen">
		
# ypinit -s nis.example.com		
		
		</pre>
	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nis.client"></a>1.3.1.3. 客户机软件安装</h4></div></div></div>
		
		<div class="procedure"><a id="idp92"></a><p class="title"><strong>过程 1.2. 安装NIS客户端软件</strong></p><ol class="procedure" type="1"><li class="step">
				<p>NIS客户机需要安装ypbind和yp-tools两个软件包</p>
				<pre class="screen">
				
# yum install ypbind yp-tools -y
				
				</pre>
			</li><li class="step">
				<p>NIS域名</p>
				<pre class="screen">
				
# nisdomainname example.com
				
				</pre>
			</li><li class="step">
				<p>/etc/hosts</p>
				<pre class="screen">
				
192.168.3.5 nis.example.com
				
				</pre>
			</li><li class="step">
				<p>/etc/yp.conf</p>
				<pre class="screen">
				
# vim /etc/yp.conf
domain example.com server nis.example.com
				
				</pre>
			</li><li class="step">
				<p>/etc/nsswitch.conf</p>
				<pre class="screen">
				
# vim /etc/nsswitch.conf
passwd: files nis
shadow: files nis
group: files nis
hosts: files nis dns
				
				</pre>
			</li><li class="step">
				<p>启动ypbind服务程序</p>
				<pre class="screen">
				
[root@test ~]# service portmap status
portmap is stopped
[root@test ~]# service portmap start
Starting portmap: [ OK ]
[root@test ~]# service ypbind start
Turning on allow_ypbind SELinux boolean
Binding to the NIS domain: [ OK ]
Listening for an NIS domain server..
				
				</pre>
			</li><li class="step">
				<p>yp-tools 测试工具</p>
				<p>yptest 命令可对NIS服务器进行自动测试</p>
				<pre class="screen">
				
# yptest	
				
				</pre>
				<p>ypwhich 命令可显示NIS客户机所使用的NIS服务器的主机名称和数据库文件列表</p>
				<pre class="screen">
				
# ypwhich
# ypwhich -x			
				
				</pre>
				<p>ypcat命令显示数据库文件列表和指定数据库的内容</p>
				<pre class="screen">
				
# ypcat -x
# ypcat passwd				
				
				</pre>
			</li><li class="step">
				<p>NIS Client Service</p>
				<pre class="screen">
				
# chkconfig ypbind on				
				
				</pre>
			</li></ol></div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nis.authentication"></a>1.3.1.4. Authentication Configuration</h4></div></div></div>
		
		<pre class="screen">
		
# authconfig-tui		
		
		</pre>
		<p>Use NIS</p>
		<pre class="screen">
		
                ┌────────────────┤ Authentication Configuration ├─────────────────┐
                │                                                                 │
                │  User Information        Authentication                         │
                │  [ ] Cache Information   [*] Use MD5 Passwords                  │
                │  [ ] Use Hesiod          [*] Use Shadow Passwords               │
                │  [ ] Use LDAP            [ ] Use LDAP Authentication            │
                │  [*] Use NIS             [ ] Use Kerberos                       │
                │  [ ] Use Winbind         [ ] Use SMB Authentication             │
                │                          [ ] Use Winbind Authentication         │
                │                          [ ] Local authorization is sufficient  │
                │                                                                 │
                │            ┌────────┐                      ┌──────┐             │
                │            │ Cancel │                      │ Next │             │
                │            └────────┘                      └──────┘             │
                │                                                                 │
                │                                                                 │
                └─────────────────────────────────────────────────────────────────┘		
		
		</pre>
		<p>NIS Settings</p>
		<pre class="screen">
		
                        ┌─────────────────┤ NIS Settings ├─────────────────┐
                        │                                                  │
                        │ Domain: example.com_____________________________ │
                        │ Server: nis.example.com_________________________ │
                        │                                                  │
                        │         ┌──────┐                 ┌────┐          │
                        │         │ Back │                 │ Ok │          │
                        │         └──────┘                 └────┘          │
                        │                                                  │
                        │                                                  │
                        └──────────────────────────────────────────────────┘
		
		</pre>
	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nis.example"></a>1.3.1.5. application example</h4></div></div></div>
		
		<p>nis server:</p>
		<p>在NIS服务器上创建一个test用户</p>
		<pre class="screen">
		
# adduser test
# passwd test
# /usr/lib64/yp/ypinit -m
		
		</pre>
		<p>nis client</p>
		<p>使用test用户登录到客户机</p>
		<pre class="screen">
		
ssh test@client.example.com		
		
		</pre>
		<p>测试</p>
		<pre class="screen">
		
[root@test ~]# yptest
Test 1: domainname
Configured domainname is "example.com"

Test 2: ypbind
Used NIS server:
nis.example.com

Test 3: yp_match
WARNING: No such key in map (Map
passwd.byname, key nobody)

Test 4: yp_first
neo
neo:$1$e1nd3pts$s7NikMnKwpL4vUp2LM/N9.:500:500::/home/neo:/bin/bash

Test 5: yp_next
test
test:$1$g4.VCB7i$I/N5W/imakprFdtP02i8/.:502:502::/home/test:/bin/bash
svnroot svnroot:!!:501:501::/home/svnroot:/bin/bash

Test 6: yp_master
nis.example.com

Test 7: yp_order
1271936660

Test 8: yp_maplist
rpc.byname
protocols.bynumber
ypservers
passwd.byname
hosts.byname
rpc.bynumber
group.bygid
services.byservicename
mail.aliases
passwd.byuid
services.byname
netid.byname
protocols.byname
group.byname
hosts.byaddr

Test 9: yp_all
neo
neo:$1$e1nd3pts$s7NikMnKwpL4vUp2LM/N9.:500:500::/home/neo:/bin/bash
test
test:$1$g4.VCB7i$I/N5W/imakprFdtP02i8/.:502:502::/home/test:/bin/bash
svnroot svnroot:!!:501:501::/home/svnroot:/bin/bash
1 tests failed		
		
		</pre>
		<p>更改密码</p>
		<pre class="screen">
		
$ yppasswd
Changing NIS account information for test on nis.example.com.
Please enter old password:
Changing NIS password for test on
nis.example.com.
Please enter new password:
Please retype new password:

The NIS password has been changed on nis.example.com.		
		
		</pre>
		<pre class="screen">
		
-bash-3.2$ ypcat hosts 
127.0.0.1 localhost.localdomain localhost 
127.0.0.1 kerberos.example.com
192.168.3.5 nis.example.com

-bash-3.2$ ypcat passwd
neo:$1$e1nd3pts$s7NikMnKwpL4vUp2LM/N9.:500:500::/home/neo:/bin/bash
test:$1$g4.VCB7i$I/N5W/imakprFdtP02i8/.:502:502::/home/test:/bin/bash
svnroot:!!:501:501::/home/svnroot:/bin/bash
		
		</pre>
		<pre class="screen">
		
-bash-3.2$
ypwhich
nis.example.com

ypwhich -x
Use "ethers" for map "ethers.byname"
Use "aliases" for map "mail.aliases"
Use "services" for map "services.byname"
Use "protocols" for map "protocols.bynumber"
Use "hosts" for map "hosts.byname"
Use "networks" for map "networks.byaddr"
Use "group" for map "group.byname"
Use "passwd" for map "passwd.byname"
		
		</pre>
	</div>

	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nis.home"></a>1.3.1.6. Mount /home volume from NFS</h4></div></div></div>
		
		<p>在NIS服务器中将“/home”输出为NFS共享目录</p>
		<pre class="screen">
		
# vi /etc/exports
/home 192.168.3.0/24(sync,rw,no_root_squash)		
		
		</pre>
		<p>重启NFS服务</p>
		<pre class="screen">
		
# service nfs restart
		
		</pre>
		<p>在NIS客户端中挂载“/home”目录</p>
		<pre class="screen">
		
		# vi /etc/fstab
192.168.1.10:/home/ /home nfs 	defaults 0 0		
		
		</pre>
		<p>mount home volume</p>
		<pre class="screen">
		
# mount /home
		
		</pre>
	</div>
</div>









		
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="network.authentication.ldap"></a>1.3.2. OpenLDAP</h3></div></div></div>
	
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp5"></a>1.3.2.1. Server</h4></div></div></div>
		
		<div class="procedure"><ol class="procedure" type="1"><li class="step">
				<p>First, install the OpenLDAP server daemon slapd and ldap-utils, a package containing LDAP management utilities:</p>
				<pre class="screen">
sudo apt-get install slapd ldap-utils				
				</pre>
				<p>By default the directory suffix will match the domain name of the server. For example, if the machine's Fully Qualified Domain Name (FQDN) is ldap.example.com, the default suffix will be dc=example,dc=com. If you require a different suffix, the directory can be	reconfigured using dpkg-reconfigure. Enter the following in a terminal prompt:</p>
				<pre class="screen">
sudo dpkg-reconfigure slapd				
				</pre>
			</li><li class="step">
				<p>example.com.ldif</p>
				<pre class="screen">
dn: ou=people,dc=example,dc=com
objectClass: organizationalUnit
ou: people

dn: ou=groups,dc=example,dc=com
objectClass: organizationalUnit
ou: groups

dn: uid=john,ou=people,dc=example,dc=com
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
uid: john
sn: Doe
givenName: John
cn: John Doe
displayName: John Doe
uidNumber: 1000
gidNumber: 10000
userPassword: password
gecos: John Doe
loginShell: /bin/bash
homeDirectory: /home/john
shadowExpire: -1
shadowFlag: 0
shadowWarning: 7
shadowMin: 8
shadowMax: 999999
shadowLastChange: 10877
mail: john.doe@example.com
postalCode: 31000
l: Toulouse
o: Example
mobile: +33 (0)6 xx xx xx xx
homePhone: +33 (0)5 xx xx xx xx
title: System Administrator
postalAddress: 
initials: JD

dn: cn=example,ou=groups,dc=example,dc=com
objectClass: posixGroup
cn: example
gidNumber: 10000
				</pre>
			</li><li class="step">
				<p>To add the entries to the LDAP directory use the ldapadd utility:</p>
				<pre class="screen">
ldapadd -x -D cn=admin,dc=example,dc=com -W -f example.com.ldif
				</pre>
				<p>We can check that the content has been correctly added with the tools from the ldap-utils package. In order to execute a search of the LDAP directory:</p>
				<pre class="screen">
ldapsearch -xLLL -b "dc=example,dc=com" uid=john sn givenName cn

dn: uid=john,ou=people,dc=example,dc=com
cn: John Doe
sn: Doe
givenName: John				
				</pre>
			</li></ol></div>
		<p>Just a quick explanation:</p>
		<p>-x: will not use SASL authentication method, which is the default.</p>
		<p>-LLL: disable printing LDIF schema information.</p>
	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp6"></a>1.3.2.2. Client</h4></div></div></div>
		
		<div class="procedure"><ol class="procedure" type="1"><li class="step">
				<p>libnss-ldap</p>
				<pre class="screen">
sudo apt-get install libnss-ldap
				</pre>
			</li><li class="step">
				<p>reconfigure ldap-auth-config</p>
				<pre class="screen">
sudo dpkg-reconfigure ldap-auth-config
				</pre>
			</li><li class="step">
				<p>auth-client-config</p>
				<pre class="screen">
sudo auth-client-config -t nss -p lac_ldap				
				</pre>
			</li><li class="step">
				<p>pam-auth-update.</p>
				<pre class="screen">
sudo pam-auth-update
				</pre>
			</li></ol></div>	
	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp7"></a>1.3.2.3. User and Group Management</h4></div></div></div>
		
		<pre class="screen">
sudo apt-get install ldapscripts
		</pre>
		<p> /etc/ldapscripts/ldapscripts.conf </p>
		<pre class="screen">
SERVER=localhost
BINDDN='cn=admin,dc=example,dc=com'
BINDPWDFILE="/etc/ldapscripts/ldapscripts.passwd"
SUFFIX='dc=example,dc=com'
GSUFFIX='ou=Groups'
USUFFIX='ou=People'
MSUFFIX='ou=Computers'
GIDSTART=10000
UIDSTART=10000
MIDSTART=10000		
		</pre>
		<p>Now, create the ldapscripts.passwd file to allow authenticated access to the directory:</p>
		<pre class="screen">
sudo sh -c "echo -n 'secret' &gt; /etc/ldapscripts/ldapscripts.passwd"
sudo chmod 400 /etc/ldapscripts/ldapscripts.passwd		
		</pre>
	</div>
</div>
		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="kerberos"></a>1.3.3. Kerberos</h3></div><div><h4 class="subtitle">（Kerberos: Network Authentication Protocol）</h4></div></div></div>
	 
	
	<p>http://web.mit.edu/Kerberos/</p>
	<p>
		kerberos是由MIT开发的提供网络认证服务的系统，很早就听说过它的大名，但一直没有使用过它。
		它可用来为网络上的各种server提供认证服务,使得口令不再是以明文方式在网络上传输，并且联接之间通讯是加密的；
		它和PKI认证的原理不一样，PKI使用公钥体制(不对称密码体制)，kerberos基于私钥体制(对称密码体制)。
	</p>

	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="kerberos.install"></a>1.3.3.1. Kerberos 安装</h4></div></div></div>
		
	<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp8"></a>1.3.3.1.1. CentOS 安装</h5></div></div></div>
		
		<p>获得krb5的安装包</p>
		<span class="command"><strong>yum search krb5</strong></span>
		<pre class="screen">
[root@centos ~]# yum search krb5
========================================== Matched: krb5 ===========================================
krb5-auth-dialog.x86_64 : Kerberos 5 authentication dialog
krb5-devel.i386 : Development files needed to compile Kerberos 5 programs.
krb5-devel.x86_64 : Development files needed to compile Kerberos 5 programs.
krb5-libs.i386 : The shared libraries used by Kerberos 5.
krb5-libs.x86_64 : The shared libraries used by Kerberos 5.
krb5-server.x86_64 : The KDC and related programs for Kerberos 5.
krb5-workstation.x86_64 : Kerberos 5 programs for use on workstations.
pam_krb5.i386 : A Pluggable Authentication Module for Kerberos 5.
pam_krb5.x86_64 : A Pluggable Authentication Module for Kerberos 5.
		</pre>
		<p>安装</p>
		<span class="command"><strong>yum install krb5-server.i386</strong></span>
		<pre class="screen">
[root@centos ~]# yum install krb5-server
Setting up Install Process
Resolving Dependencies
--&gt; Running transaction check
---&gt; Package krb5-server.x86_64 0:1.6.1-36.el5_4.1 set to be updated
--&gt; Finished Dependency Resolution

Dependencies Resolved

====================================================================================================
 Package                 Arch               Version                       Repository           Size
====================================================================================================
Installing:
 krb5-server             x86_64             1.6.1-36.el5_4.1              updates             914 k

Transaction Summary
====================================================================================================
Install      1 Package(s)
Update       0 Package(s)
Remove       0 Package(s)

Total download size: 914 k
Is this ok [y/N]: y
Downloading Packages:
krb5-server-1.6.1-36.el5_4.1.x86_64.rpm                                      | 914 kB     00:01
Running rpm_check_debug
Running Transaction Test
Finished Transaction Test
Transaction Test Succeeded
Running Transaction
  Installing     : krb5-server                                                                  1/1

Installed:
  krb5-server.x86_64 0:1.6.1-36.el5_4.1

Complete!
[root@datacenter ~]#Setting up Install Process
Resolving Dependencies
--&gt; Running transaction check
---&gt; Package krb5-server.x86_64 0:1.6.1-36.el5_4.1 set to be updated
--&gt; Finished Dependency Resolution

Dependencies Resolved

====================================================================================================
 Package                 Arch               Version                       Repository           Size
====================================================================================================
Installing:
 krb5-server             x86_64             1.6.1-36.el5_4.1              updates             914 k

Transaction Summary
====================================================================================================
Install      1 Package(s)
Update       0 Package(s)
Remove       0 Package(s)

Total download size: 914 k
Is this ok [y/N]: y
Downloading Packages:
krb5-server-1.6.1-36.el5_4.1.x86_64.rpm                                      | 914 kB     00:01
Running rpm_check_debug
Running Transaction Test
Finished Transaction Test
Transaction Test Succeeded
Running Transaction
  Installing     : krb5-server                                                                  1/1

Installed:
  krb5-server.x86_64 0:1.6.1-36.el5_4.1

Complete!
		</pre>
		<span class="command"><strong>yum install krb5-workstation</strong></span>
		<pre class="screen">
[root@centos ~]# yum install krb5-workstation
		</pre>
		<span class="command"><strong>yum install krb5-libs</strong></span>
		<pre class="screen">
		
		</pre>
	</div>
	<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp9"></a>1.3.3.1.2. Install by apt-get</h5></div></div></div>
		
		<div class="procedure"><a id="idp94"></a><p class="title"><strong>过程 1.3. installation</strong></p><ol class="procedure" type="1"><li class="step">
				<pre class="screen">
$ sudo apt-get install krb5-admin-server		
				</pre>		
			</li><li class="step">
				<p>Configuring</p>
				<pre class="screen">
				
  ┌──────────────────────────────┤ Configuring krb5-admin-server ├───────────────────────────────┐
  │                                                                                              │
  │ Setting up a Kerberos Realm                                                                  │
  │                                                                                              │
  │ This package contains the administrative tools required to run the Kerberos master server.   │
  │                                                                                              │
  │ However, installing this package does not automatically set up a Kerberos realm.  This can   │
  │ be done later by running the "krb5_newrealm" command.                                        │
  │                                                                                              │
  │ Please also read the /usr/share/doc/krb5-kdc/README.KDC file and the administration guide    │
  │ found in the krb5-doc package.                                                               │
  │                                                                                              │
  │                                            &lt;Ok&gt;                                              │
  │                                                                                              │
  └──────────────────────────────────────────────────────────────────────────────────────────────┘
				
				</pre>
				<p>OK</p>
				<pre class="screen">
				
 ┌───────────────────────────────┤ Configuring krb5-admin-server ├───────────────────────────────┐
 │                                                                                               │
 │ Kadmind serves requests to add/modify/remove principals in the Kerberos database.             │
 │                                                                                               │
 │ It is required by the kpasswd program, used to change passwords. With standard setups, this   │
 │ daemon should run on the master KDC.                                                          │
 │                                                                                               │
 │ Run the Kerberos V5 administration daemon (kadmind)?                                          │
 │                                                                                               │
 │                           &lt;Yes&gt;                              &lt;No&gt;                             │
 │                                                                                               │
 └───────────────────────────────────────────────────────────────────────────────────────────────┘				
				
				</pre>
				<p>Yes</p>
			</li></ol></div>
	</div>	
	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="kerberos.server"></a>1.3.3.2. Kerberos Server</h4></div></div></div> 
		
		<div class="procedure"><a id="idp95"></a><p class="title"><strong>过程 1.4. Kerberos Server 配置步骤</strong></p><ol class="procedure" type="1"><li class="step">
				<p>Create the Database</p>
				<p>创建Kerberos的本地数据库</p>
				<span class="command"><strong>kdb5_util create -r EXAMPLE.COM -s</strong></span>
				<pre class="screen">
[root@datacenter ~]# kdb5_util create -r EXAMPLE.COM -s
Loading random data
Initializing database '/var/kerberos/krb5kdc/principal' for realm 'EXAMPLE.COM',
master key name 'K/M@EXAMPLE.COM'
You will be prompted for the database Master Password.
It is important that you NOT FORGET this password.
Enter KDC database master key:
Re-enter KDC database master key to verify:		
				</pre>			
			</li><li class="step">
				<p>/etc/krb5.conf</p>
				<pre class="screen">
# cp /etc/krb5.conf /etc/krb5.conf.old
# vim /etc/krb5.conf
[logging]
 default = FILE:/var/log/krb5libs.log
 kdc = FILE:/var/log/krb5kdc.log
 admin_server = FILE:/var/log/kadmind.log

[libdefaults]
 default_realm = EXAMPLE.COM
 dns_lookup_realm = false
 dns_lookup_kdc = false
 ticket_lifetime = 24h
 forwardable = yes

[realms]
 EXAMPLE.COM = {
  kdc = kerberos.example.com:88
  admin_server = kerberos.example.com:749
  default_domain = example.com
 }

[domain_realm]
 .example.com = EXAMPLE.COM
 example.com = EXAMPLE.COM

[appdefaults]
 pam = {
   debug = false
   ticket_lifetime = 36000
   renew_lifetime = 36000
   forwardable = true
   krb4_convert = false
 }
				</pre>
				<p>检查下面配置文件 /var/kerberos/krb5kdc/kadm5.acl</p>
				<pre class="screen">
[root@datacenter ~]# cat /var/kerberos/krb5kdc/kadm5.acl
*/admin@EXAMPLE.COM     *
				</pre>
				<p>格式</p>
				<pre class="screen">
The format of the file is:

     Kerberos_principal      permissions     [target_principal]	[restrictions]
				</pre>				
			</li><li class="step">
				<p>Add Administrators to the Kerberos Database</p>
				<p>创建账号</p>
				<pre class="screen">
[root@datacenter ~]# kadmin.local
Authenticating as principal root/admin@EXAMPLE.COM with password.
kadmin.local:  addprinc admin/admin@EXAMPLE.COM
WARNING: no policy specified for admin/admin@EXAMPLE.COM; defaulting to no policy
Enter password for principal "admin/admin@EXAMPLE.COM":
Re-enter password for principal "admin/admin@EXAMPLE.COM":
Principal "admin/admin@EXAMPLE.COM" created.
kadmin.local:
				</pre>
				<p>也同样可以使用下面命令</p>
				<span class="command"><strong>kadmin.local -q "addprinc username/admin"</strong></span>
				<pre class="screen">
[root@datacenter ~]# kadmin.local -q "addprinc krbuser"
Authenticating as principal admin/admin@EXAMPLE.COM with password.
WARNING: no policy specified for krbuser@EXAMPLE.COM; defaulting to no policy
Enter password for principal "krbuser@EXAMPLE.COM":
Re-enter password for principal "krbuser@EXAMPLE.COM":
Principal "krbuser@EXAMPLE.COM" created.
				</pre>
				
			</li><li class="step">
				<p>Create a kadmind Keytab</p>
				<pre class="screen">
				
[root@datacenter ~]# kadmin.local -q  "ktadd -k /var/kerberos/krb5kdc/kadm5.keytab =&gt; kadmin/admin kadmin/changepw"
Authenticating as principal admin/admin@EXAMPLE.COM with password.
kadmin.local: Principal =&gt; does not exist.
Entry for principal kadmin/admin with kvno 3, encryption type Triple DES cbc mode with HMAC/sha1 added to keytab WRFILE:/var/kerberos/krb5kdc/kadm5.keytab.
Entry for principal kadmin/admin with kvno 3, encryption type DES cbc mode with CRC-32 added to keytab WRFILE:/var/kerberos/krb5kdc/kadm5.keytab.
Entry for principal kadmin/changepw with kvno 3, encryption type Triple DES cbc mode with HMAC/sha1 added to keytab WRFILE:/var/kerberos/krb5kdc/kadm5.keytab.
Entry for principal kadmin/changepw with kvno 3, encryption type DES cbc mode with CRC-32 added to keytab WRFILE:/var/kerberos/krb5kdc/kadm5.keytab.				
				
				</pre>
			</li><li class="step">
				<p>Start the Kerberos Daemons on the Master KDC</p>
				<p>启动 Kerberos进程</p>			
				<pre class="screen">
[root@datacenter ~]# sudo /etc/init.d/krb524 start
Starting Kerberos 5-to-4 Server:                           [  OK  ]

[root@datacenter ~]# sudo /etc/init.d/krb5kdc restart
Stopping Kerberos 5 KDC:                                   [  OK  ]
Starting Kerberos 5 KDC:                                   [  OK  ]

[root@datacenter ~]# sudo /etc/init.d/kadmin start
Starting Kerberos 5 Admin Server:                          [  OK  ]
				</pre>
			</li><li class="step">
				<p>Log 文件</p>
				<pre class="screen">
[root@datacenter ~]# cat /var/log/krb5kdc.log

[root@datacenter ~]# cat /var/log/krb5libs.log

[root@datacenter ~]# cat /var/log/kadmind.log
				</pre>				
			</li></ol></div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="kerberos.client"></a>1.3.3.3. Kerberos Client</h4></div></div></div> 
				
		<div class="procedure"><a id="idp96"></a><p class="title"><strong>过程 1.5. Kerberos Client 配置步骤</strong></p><ol class="procedure" type="1"><li class="step">
				<p>Ticket Management</p>
				<ol type="a" class="substeps">

			<li class="step">
				<p>Obtaining Tickets with kinit</p>
				<pre class="screen">
[root@datacenter ~]# kinit admin/admin
Password for admin/admin@EXAMPLE.COM:				
				</pre>
			</li>
			<li class="step">
				<p>Viewing Your Tickets with klist</p>
				<pre class="screen">
[root@datacenter ~]# klist
Ticket cache: FILE:/tmp/krb5cc_0
Default principal: admin/admin@EXAMPLE.COM

Valid starting     Expires            Service principal
03/25/10 16:15:18  03/26/10 16:15:18  krbtgt/EXAMPLE.COM@ZEXAMPLECOM


Kerberos 4 ticket cache: /tmp/tkt0
klist: You have no tickets cached
				</pre>
			</li>
			<li class="step">
				<p>Destroying Your Tickets with kdestroy</p>
				<pre class="screen">
[root@datacenter ~]# kdestroy
[root@datacenter ~]# klist
klist: No credentials cache found (ticket cache FILE:/tmp/krb5cc_0)


Kerberos 4 ticket cache: /tmp/tkt0
klist: You have no tickets cached
				</pre>
			</li>				
				</ol>
			</li><li class="step">
				<p>Password Management</p>
				<p>Changing Your Password</p>
				<pre class="screen"> 
				   
[root@datacenter ~]# kpasswd
Password for admin/admin@EXAMPLE.COM:
Enter new password:
Enter it again:
Password changed.
				
				</pre>				
			</li></ol></div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="kerberos.management"></a>1.3.3.4. Kerberos Management</h4></div></div></div>
		
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp10"></a>1.3.3.4.1. ktutil - Kerberos keytab file maintenance utility</h5></div></div></div>
			
			<pre class="screen">
[root@datacenter ~]# ktutil
ktutil: rkt /var/kerberos/krb5kdc/kadm5.keytab
ktutil:  l
slot KVNO Principal
---- ---- ---------------------------------------------------------------------
   1    3                  kadmin/admin@EXAMPLE.COM
   2    3                  kadmin/admin@EXAMPLE.COM
   3    3               kadmin/changepw@EXAMPLE.COM
   4    3               kadmin/changepw@EXAMPLE.COM
ktutil: q
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp11"></a>1.3.3.4.2. klist - list cached Kerberos tickets</h5></div></div></div>
			
			<pre class="screen">
[root@datacenter ~]# klist
Ticket cache: FILE:/tmp/krb5cc_0
Default principal: admin/admin@EXAMPLE.COM

Valid starting     Expires            Service principal
03/25/10 16:53:02  03/26/10 16:53:02  krbtgt/EXAMPLE.COM@EXAMPLE.COM
03/25/10 17:02:10  03/26/10 16:53:02  host/172.16.0.8@


Kerberos 4 ticket cache: /tmp/tkt0
klist: You have no tickets cached
			</pre>
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="kerberos.openssh"></a>1.3.3.5. OpenSSH Authentications</h4></div></div></div>
		
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp12"></a>1.3.3.5.1. Configuring the Application server system</h5></div></div></div>
				
			<pre class="screen">
[root@datacenter ~]# kinit   admin/admin
Password for admin/admin@EXAMPLE.COM:

[root@datacenter ~]# kadmin.local -q "addprinc -randkey host/172.16.0.8"
Authenticating as principal admin/admin@EXAMPLE.COM with password.
WARNING: no policy specified for host/172.16.0.8@EXAMPLE.COM; defaulting to no policy
Principal "host/172.16.0.8@EXAMPLE.COM" created.

[root@datacenter ~]# kadmin.local -q " ktadd -k /var/kerberos/krb5kdc/kadm5.keytab host/172.16.0.8"
Authenticating as principal admin/admin@EXAMPLE.COM with password.
Entry for principal host/172.16.0.8 with kvno 3, encryption type Triple DES cbc mode with HMAC/sha1 added to keytab WRFILE:/var/kerberos/krb5kdc/kadm5.keytab.
Entry for principal host/172.16.0.8 with kvno 3, encryption type DES cbc mode with CRC-32 added to keytab WRFILE:/var/kerberos/krb5kdc/kadm5.keytab.
[root@datacenter ~]# ktutil
ktutil:  rkt /var/kerberos/krb5kdc/kadm5.keytab
ktutil:  l
slot KVNO Principal
---- ---- ---------------------------------------------------------------------
   1    3                  kadmin/admin@EXAMPLE.COM
   2    3                  kadmin/admin@EXAMPLE.COM
   3    3               kadmin/changepw@EXAMPLE.COM
   4    3               kadmin/changepw@EXAMPLE.COM
   5    3               host/172.16.0.8@EXAMPLE.COM
   6    3               host/172.16.0.8@EXAMPLE.COM
ktutil:  q
[root@datacenter ~]#
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp13"></a>1.3.3.5.2. Configuring the Application client system</h5></div></div></div>
			
			<p>/etc/ssh/sshd_config</p>
			<pre class="screen">
KerberosAuthentication yes
			</pre>
		</div>
	</div>
</div>
		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="freeradius"></a>1.3.4. FreeRADIUS (Remote Authentication Dial In User Service)</h3></div><div><h4 class="subtitle">radiusd - Authentication, Authorization and Accounting server</h4></div></div></div>
	
	
	<p>I want to authorize Wi-Fi Protected Access with freeradius  for Wi-Fi Route.</p>
	<p>http://freeradius.org/</p>
	<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>debian/ubuntu</p></li><li class="listitem"><p>FreeRADIUS</p></li><li class="listitem"><p>D-Link DI-624+A</p></li></ul></div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp16"></a>1.3.4.1. 安装 FreeRADIUS</h4></div></div></div>
		
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp14"></a>1.3.4.1.1. Ubuntu</h5></div></div></div>
			
			<p>some package of freeradius.</p>
			<pre class="screen">
netkiller@shenzhen:~$ apt-cache search freeradius

freeradius - a high-performance and highly configurable RADIUS server
freeradius-dialupadmin - set of PHP scripts for administering a FreeRADIUS server
freeradius-iodbc - iODBC module for FreeRADIUS server
freeradius-krb5 - kerberos module for FreeRADIUS server
freeradius-ldap - LDAP module for FreeRADIUS server
freeradius-mysql - MySQL module for FreeRADIUS server
			</pre>
			<p>install</p>
			<pre class="screen">
netkiller@shenzhen:~$ sudo apt-get install freeradius
			</pre>
			<p>OK, we have installed let's quickly test it. the '******' is your password.</p>
			<pre class="screen">
netkiller@shenzhen:~$ radtest netkiller ****** localhost 0 testing123
Sending Access-Request of id 237 to 127.0.0.1 port 1812
        User-Name = "netkiller"
        User-Password = "******"
        NAS-IP-Address = 255.255.255.255
        NAS-Port = 0
rad_recv: Access-Accept packet from host 127.0.0.1:1812, id=237, length=20
			</pre>
			<p>if you can see 'Access-Accept', you have succeed</p>
			<p>let me to input an incorrect password.</p>
			<pre class="screen">
netkiller@shenzhen:~$ radtest netkiller ****** localhost 0 testing123
Sending Access-Request of id 241 to 127.0.0.1 port 1812
        User-Name = "netkiller"
        User-Password = "******"
        NAS-IP-Address = 255.255.255.255
        NAS-Port = 0
Re-sending Access-Request of id 241 to 127.0.0.1 port 1812
        User-Name = "netkiller"
        User-Password = "******"
        NAS-IP-Address = 255.255.255.255
        NAS-Port = 0
rad_recv: Access-Reject packet from host 127.0.0.1:1812, id=241, length=20
			</pre>
			<p>you will see 'Access-Reject'.</p>
			<p>默认你只能通过localhost访问radius, 如需其他网络访问需要在配置文件中添加类似下面配置，配置文件在  /etc/freeradius/clients.conf</p>
			<pre class="screen">
# vim /etc/freeradius/clients.conf

client 172.16.0.0/24 {
       secret          = testing123
       shortname       = freeradius.example.com
}
			</pre>
		</div>		
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp15"></a>1.3.4.1.2. 安装 radiusd</h5></div></div></div>
			
			<p>CentOS与Ubuntu安装包有所不同，配置文件在 /etc/raddb下面</p>
			<div class="procedure"><a id="idp98"></a><p class="title"><strong>过程 1.6. 安装步骤</strong></p><ol class="procedure" type="1"><li class="step">
					<p>yum 安装</p>
					<pre class="screen">
yum install -y freeradius
					</pre>
					<pre class="screen">
# yum install freeradius freeradius-utils			
					</pre>
				</li><li class="step">
					<p>设置启动文件</p>
					<pre class="screen">
chkconfig radiusd on
service radiusd start
					</pre>
				</li><li class="step">
					<p>配置 radiusd</p>
					<pre class="screen">
cp /etc/raddb/clients.conf{,.original}
cp /etc/raddb/users{,.original}
cp /etc/raddb/sites-enabled/default{,.original}
					</pre>	
					<pre class="screen">
					
cat &gt;&gt; /etc/raddb/clients.conf &lt;&lt;EOF

client 192.168.0.0/16 {
       secret          = testing123
       shortname       = freeradius.example.com
}
EOF				
					
					</pre>			
					<p>/etc/raddb/users</p>
					<pre class="screen">
guest Cleartext-Password := "test"
					</pre>
					<p>/etc/raddb/sites-enabled/default</p>	
					<pre class="screen">
					</pre>
				</li><li class="step">
					<p>测试 radiusd</p>
					<pre class="screen">
$ radtest guest test 192.168.2.1 1812 testing123
Sending Access-Request of id 223 to 192.168.2.1 port 1812
	User-Name = "guest"
	User-Password = "test"
	NAS-IP-Address = 127.0.1.1
	NAS-Port = 1812
	Message-Authenticator = 0x00000000000000000000000000000000
rad_recv: Access-Accept packet from host 192.168.2.1 port 1812, id=223, length=20
					</pre>
				</li></ol></div>
		</div>
			
	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="freeradius.ldap"></a>1.3.4.2. ldap</h4></div></div></div>
		
		<p></p>

	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="freeradius.mysql"></a>1.3.4.3. mysql</h4></div></div></div>
		
		<p></p>

	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="freeradius.wap2"></a>1.3.4.4. WAP2 Enterprise</h4></div></div></div>
		
		<p>WRT54G</p>

	</div>
</div>
		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="sasl"></a>1.3.5. SASL (Simple Authentication and Security Layer)</h3></div></div></div>
			
		</div>
		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="gssapi"></a>1.3.6. GSSAPI (Generic Security Services Application Program Interface)</h3></div></div></div>
			

		</div>
	</div><div xmlns="" id="disqus_thread"></div><script xmlns="">

var disqus_config = function () {
this.page.url = "http://www.netkiller.cn";  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = 'netkiller'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//netkiller.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script><noscript xmlns="">Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><br xmlns="" /><script xmlns="" type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=r5HG&amp;d=9mi5r_kkDC8uxG8HuY3p4-2qgeeVypAK9vMD-2P6BYM"></script><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="pam.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="index.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="../sniffer.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">1.2. PAM 插件认证 </td><td width="20%" align="center"><a accesskey="h" href="../index.html">起始页</a></td><td width="40%" align="right" valign="top"> 第 2 章 Sniffer</td></tr></table></div><script xmlns="">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-11694057-1', 'auto');
  ga('send', 'pageview');

</script><script xmlns="" async="async">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?93967759a51cda79e49bf4e34d0b0f2c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script xmlns="" async="async">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script><script xmlns="" type="text/javascript" src="/js/q.js" async="async"></script></body></html>