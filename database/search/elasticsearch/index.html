<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>第 8 章 Elasticsearch</title><link rel="stylesheet" type="text/css" href="../..//docbook.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><meta name="keywords" content="MySQL, PostgreSQL, Oracle, NoSQL, ER, TokyoCabinet/Tyrant, Memcache, Membase, Redis, Flare, Voldemort, LevelDB, MongoDB, GreenSQL, RDBMS, ORDBMS" /><link rel="home" href="../../index.html" title="Netkiller Database 手札" /><link rel="up" href="../index.html" title="部分 II. Search Engine" /><link rel="prev" href="../index.html" title="部分 II. Search Engine" /><link rel="next" href="document.html" title="8.2. 文档API" /></head><body><a xmlns="" href="//www.netkiller.cn/">Home</a> |
		<a xmlns="" href="//netkiller.github.io/">简体中文</a> |
	    <a xmlns="" href="http://netkiller.sourceforge.net/">繁体中文</a> |
	    <a xmlns="" href="/journal/index.html">杂文</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/donations.html">打赏(Donations)</a> |
	    <a xmlns="" href="https://github.com/netkiller">Github</a> |
	    <a xmlns="" href="http://my.oschina.net/neochen/">OSChina 博客</a> |
	    <a xmlns="" href="https://cloud.tencent.com/developer/column/2078">云社区</a> |
	    <a xmlns="" href="https://yq.aliyun.com/u/netkiller/">云栖社区</a> |
	    <a xmlns="" href="https://www.facebook.com/bg7nyt">Facebook</a> |
	    <a xmlns="" href="http://cn.linkedin.com/in/netkiller/">Linkedin</a> |
	    <a xmlns="" href="https://zhuanlan.zhihu.com/netkiller">知乎专栏</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/video.html">视频教程</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/about.html">About</a><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">第 8 章 Elasticsearch</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="../index.html">上一页</a> </td><th width="60%" align="center">部分 II. Search Engine</th><td width="20%" align="right"> <a accesskey="n" href="document.html">下一页</a></td></tr></table><hr /></div><table xmlns=""><tr><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=watch&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=fork&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;type=follow&amp;count=true&amp;size=large" height="30" width="240" frameborder="0" scrolling="0" style="width:240px; height: 30px;" allowTransparency="true"></iframe></td></tr></table><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="index"></a>第 8 章 Elasticsearch</h2></div></div></div><div class="toc"><p><strong>目录</strong></p><dl class="toc"><dt><span class="section"><a href="index.html#install">8.1. 安装 Elasticsearch</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#">8.1.1. 6.x 安装</a></span></dt><dt><span class="section"><a href="index.html#single">8.1.2. 单机模式 (适用于开发环境) 5.x </a></span></dt><dt><span class="section"><a href="index.html#cluster">8.1.3. Elasticsearch Cluster 5.x</a></span></dt><dt><span class="section"><a href="index.html#loadbalance">8.1.4. 负载均衡配置</a></span></dt><dt><span class="section"><a href="index.html#version">8.1.5. 安装指定版本的 Elasticsearch</a></span></dt><dt><span class="section"><a href="index.html#plugin">8.1.6. Plugin</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#elasticsearch-analysis-ik">8.1.6.1. elasticsearch-analysis-ik</a></span></dt><dt><span class="section"><a href="index.html#elasticsearch-analysis-pinyin">8.1.6.2. elasticsearch-analysis-pinyin</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="document.html">8.2. 文档API</a></span></dt><dd><dl><dt><span class="section"><a href="document.html#quickstart">8.2.1. 快速上手</a></span></dt><dt><span class="section"><a href="document.html#put">8.2.2. 写入 PUT/POST</a></span></dt><dt><span class="section"><a href="document.html#get">8.2.3. 获取 GET</a></span></dt><dd><dl><dt><span class="section"><a href="document.html#idp12">8.2.3.1. _source</a></span></dt></dl></dd><dt><span class="section"><a href="document.html#head">8.2.4. 检查记录是否存在</a></span></dt><dt><span class="section"><a href="document.html#delete">8.2.5. 删除 Delete</a></span></dt><dt><span class="section"><a href="document.html#param">8.2.6. 参数</a></span></dt><dd><dl><dt><span class="section"><a href="document.html#idp13">8.2.6.1. pretty 格式化 json</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="search.html">8.3. 搜索</a></span></dt><dd><dl><dt><span class="section"><a href="search.html#query">8.3.1. URL 搜索</a></span></dt><dt><span class="section"><a href="search.html#search.page">8.3.2. 分页</a></span></dt></dl></dd><dt><span class="section"><a href="dsl.html">8.4. Query DSL</a></span></dt><dd><dl><dt><span class="section"><a href="dsl.html#match">8.4.1. match 匹配</a></span></dt><dt><span class="section"><a href="dsl.html#multi_match">8.4.2. multi_match 多字段匹配</a></span></dt><dt><span class="section"><a href="dsl.html#bool">8.4.3. Query bool 布尔条件</a></span></dt><dd><dl><dt><span class="section"><a href="dsl.html#idp14">8.4.3.1. must</a></span></dt><dt><span class="section"><a href="dsl.html#idp15">8.4.3.2. should</a></span></dt><dt><span class="section"><a href="dsl.html#idp16">8.4.3.3. must_not</a></span></dt></dl></dd><dt><span class="section"><a href="dsl.html#filter">8.4.4. filter 过滤</a></span></dt><dt><span class="section"><a href="dsl.html#sort">8.4.5. sort 排序</a></span></dt><dt><span class="section"><a href="dsl.html#_source">8.4.6. _source</a></span></dt><dt><span class="section"><a href="dsl.html#highlight">8.4.7. highlight 高亮处理</a></span></dt></dl></dd><dt><span class="section"><a href="manager.html">8.5. 集群管理</a></span></dt><dd><dl><dt><span class="section"><a href="manager.html#health">8.5.1. 节点健康状态</a></span></dt><dt><span class="section"><a href="manager.html#nodes">8.5.2. 节点http状态</a></span></dt><dt><span class="section"><a href="manager.html#master">8.5.3. 查看master节点</a></span></dt><dt><span class="section"><a href="manager.html#shards">8.5.4. 查看索引的节点分布</a></span></dt><dt><span class="section"><a href="manager.html#idp19">8.5.5. 索引的开启与关闭</a></span></dt><dd><dl><dt><span class="section"><a href="manager.html#idp17">8.5.5.1. _open</a></span></dt><dt><span class="section"><a href="manager.html#idp18">8.5.5.2. _close</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="elasticsearch-analysis-ik.html">8.6. 中文分词插件管理</a></span></dt><dd><dl><dt><span class="section"><a href="elasticsearch-analysis-ik.html#idp20">8.6.1. 通过 elasticsearch-plugin 命令安装分词插件</a></span></dt><dt><span class="section"><a href="elasticsearch-analysis-ik.html#plugin.install">8.6.2. 手工安装插件</a></span></dt><dt><span class="section"><a href="elasticsearch-analysis-ik.html#plugin.index">8.6.3. 创建索引</a></span></dt><dt><span class="section"><a href="elasticsearch-analysis-ik.html#plugin.delete">8.6.4. 删除索引</a></span></dt><dt><span class="section"><a href="elasticsearch-analysis-ik.html#plugin.config">8.6.5. 配置索引分词插件</a></span></dt><dd><dl><dt><span class="section"><a href="elasticsearch-analysis-ik.html#idp21">8.6.5.1. 测试分词效果</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="index.html">8.7. 索引管理</a></span></dt><dd><dl><dt><span class="section"><a href="index.html#index.indices">8.7.1. 查看索引</a></span></dt><dt><span class="section"><a href="index.html#index.delete">8.7.2. 删除索引</a></span></dt></dl></dd><dt><span class="section"><a href="mapping.html">8.8. 映射</a></span></dt><dd><dl><dt><span class="section"><a href="mapping.html#mapping.get">8.8.1. 查看 _mapping</a></span></dt><dt><span class="section"><a href="mapping.html#mapping.delete">8.8.2. 删除 _mapping </a></span></dt><dt><span class="section"><a href="mapping.html#mapping.post">8.8.3. 创建 _mapping</a></span></dt><dt><span class="section"><a href="mapping.html#mapping.update">8.8.4. 更新 mapping</a></span></dt><dt><span class="section"><a href="mapping.html#mapping.change">8.8.5. 修改 _mapping</a></span></dt><dt><span class="section"><a href="mapping.html#type">8.8.6. 数据类型</a></span></dt><dd><dl><dt><span class="section"><a href="mapping.html#idp22">8.8.6.1. date</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="alias.html">8.9. Alias management 别名管理</a></span></dt><dd><dl><dt><span class="section"><a href="alias.html#idp23">8.9.1. 查看索引别名</a></span></dt><dt><span class="section"><a href="alias.html#idp24">8.9.2. 创建索引别名</a></span></dt><dt><span class="section"><a href="alias.html#idp25">8.9.3. 修改别名</a></span></dt><dt><span class="section"><a href="alias.html#idp26">8.9.4. 删除别名</a></span></dt></dl></dd><dt><span class="section"><a href="example.html">8.10. Example</a></span></dt><dd><dl><dt><span class="section"><a href="example.html#idp27">8.10.1. 新闻资讯应用案例</a></span></dt><dt><span class="section"><a href="example.html#idp28">8.10.2. 文章搜索案例</a></span></dt></dl></dd><dt><span class="section"><a href="jdbc-input-plugin.html">8.11. Migrating MySQL Data into Elasticsearch using logstash</a></span></dt><dd><dl><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.install">8.11.1. 安装 logstash</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.config">8.11.2. 配置 logstash</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.start">8.11.3. 启动 Logstash</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.test">8.11.4. 验证</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.template">8.11.5. 配置模板</a></span></dt><dd><dl><dt><span class="section"><a href="jdbc-input-plugin.html#idp29">8.11.5.1. 全量导入</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#idp30">8.11.5.2. 多表导入</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#idp31">8.11.5.3. 通过 ID 主键字段增量复制数据</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#idp32">8.11.5.4. 通过日期字段增量复制数据</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#idp33">8.11.5.5. 指定SQL文件</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#idp34">8.11.5.6. 参数传递</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#idp35">8.11.5.7. 控制返回JDBC数据量</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#idp36">8.11.5.8. 输出到不同的 Elasticsearch 中</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#idp37">8.11.5.9. 日期格式转换</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.example">8.11.5.10. example</a></span></dt></dl></dd><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.sync">8.11.6. 解决数据不对称问题</a></span></dt><dt><span class="section"><a href="jdbc-input-plugin.html#logstash.mapping">8.11.7. 修改 Mapping</a></span></dt></dl></dd><dt><span class="section"><a href="install.html">8.12. 安装 Elasticsearch 2.3</a></span></dt><dd><dl><dt><span class="section"><a href="install.html#idp38">8.12.1. RPM 安装</a></span></dt><dt><span class="section"><a href="install.html#idp39">8.12.2. YUM 安装</a></span></dt><dt><span class="section"><a href="install.html#idp40">8.12.3. 测试安装是否正常</a></span></dt><dt><span class="section"><a href="install.html#plugin">8.12.4. Plugin 插件管理</a></span></dt><dd><dl><dt><span class="section"><a href="install.html#idp41">8.12.4.1. 手工安装插件</a></span></dt><dt><span class="section"><a href="install.html#idp42">8.12.4.2. plugin 命令</a></span></dt><dt><span class="section"><a href="install.html#idp43">8.12.4.3. 插件测试</a></span></dt></dl></dd></dl></dd><dt><span class="section"><a href="faq.html">8.13. FAQ</a></span></dt><dd><dl><dt><span class="section"><a href="faq.html#idp44">8.13.1. Plugin [analysis-ik] is incompatible with Elasticsearch [2.3.5]. Was designed for version [2.3.4]</a></span></dt><dt><span class="section"><a href="faq.html#idp45">8.13.2. plugin [analysis-ik] is incompatible with version [5.6.1]; was designed for version [5.5.2]</a></span></dt><dt><span class="section"><a href="faq.html#idp46">8.13.3. mapper_parsing_exception: failed to parse [ctime]</a></span></dt><dt><span class="section"><a href="faq.html#idp47">8.13.4. 配置 JAVA_HOME</a></span></dt></dl></dd></dl></div>
	
	<p>http://www.elasticsearch.org/</p>
	<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="install"></a>8.1. 安装 Elasticsearch</h2></div></div></div>
		
		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id=""></a>8.1.1. 6.x 安装</h3></div></div></div>
			
			<p>安装 6.x 仓库</p>
			<pre class="screen">
			
curl -s https://raw.githubusercontent.com/oscm/shell/master/search/elastic/elastic-6.x.sh | bash			
			
			</pre>
			<p>安装 6.x 包</p>
			<pre class="screen">
			
yum install elasticsearch			
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="single"></a>8.1.2. 单机模式 (适用于开发环境) 5.x </h3></div></div></div>
			
			<p>使用 Netkiller OSCM 一键安装 Elasticsearch 5.6.0</p>
			<pre class="screen">
# Java
curl -s https://raw.githubusercontent.com/oscm/shell/master/lang/java/openjdk/java-1.8.0-openjdk.sh | bash

# Install
curl -s https://raw.githubusercontent.com/oscm/shell/master/search/elasticsearch/elasticsearch-5.x.sh | bash

# Bind 0.0.0.0
curl -s https://raw.githubusercontent.com/oscm/shell/master/search/elasticsearch/network.bind_host.sh | bash

# Auto create index
curl -s https://raw.githubusercontent.com/oscm/shell/master/search/elasticsearch/action.auto_create_index.sh | bash

# elasticsearch-analysis-ik

curl -s https://raw.githubusercontent.com/oscm/shell/master/search/elasticsearch/5.5/elasticsearch-analysis-ik-5.6.0.sh | bash
			</pre>
			<p>通常 elasticsearch-analysis-ik 的版本会比 elasticsearch 慢一个版本，所以请使用下面命令查看版本是否一致，如果不一致可以修改 plugin-descriptor.properties 配置文件，使其一致。</p>
			<pre class="screen">
root@netkiller /usr/share/elasticsearch/plugins/ik % grep ^version plugin-descriptor.properties
version=5.5.1
			</pre>
			<p>启动后使用 jps 命令检查进城是否工作正常</p>
			<pre class="screen">
root@netkiller /var/log/elasticsearch % jps | grep Elasticsearch
9706 Elasticsearch

root@netkiller /var/log/elasticsearch % ss -lnt | grep 9200
LISTEN     0      128    127.0.0.1:9200                     *:*
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="cluster"></a>8.1.3. Elasticsearch Cluster 5.x</h3></div></div></div>
			
			<p>集群模式需要两个以上的节点，通常是一个 master 节点，多个 data 节点</p>
			<p>首先在所有节点上安装 elasticsearch，然后配置各节点的配置文件，对于 5.5.1 不需要配置决定哪些节点属于 master 节点 或者 data 节点。</p>
			<pre class="screen">
curl -s https://raw.githubusercontent.com/oscm/shell/master/search/elasticsearch/elasticsearch-5.x.sh | bash			
			</pre>
			<p>配置文件</p>
			<pre class="screen">
cluster.name: elasticsearch-cluster # 配置集群名称,所有服务器服务器保持一致

node.name: node-1 # 每个节点唯一标识，每个节点只需改动这里，一次递增 node-1, node-2, node-3 ...

network.host: 0.0.0.0

discovery.zen.ping.unicast.hosts: ["172.16.0.20", "172.16.0.21","172.16.0.22"]  # 所有节点的IP 地址写在这里

discovery.zen.minimum_master_nodes: 3 # 可以作为master的节点总数，有多少个节点就写多少

http.cors.enabled: true
http.cors.allow-origin: "*"
			</pre>
			<p>查看节点状态，使用curl工具: curl 'http://localhost:9200/_nodes/process?pretty'</p>
			<pre class="screen">
root@netkiller /var/log/elasticsearch % curl 'http://localhost:9200/_nodes/process?pretty'
{
  "_nodes" : {
    "total" : 2,
    "successful" : 2,
    "failed" : 0
  },
  "cluster_name" : "my-application",
  "nodes" : {
    "-lnKCmBXRpiwExLns0jc9g" : {
      "name" : "node-1",
      "transport_address" : "10.104.3.2:9300",
      "host" : "10.104.3.2",
      "ip" : "10.104.3.2",
      "version" : "5.5.1",
      "build_hash" : "19c13d0",
      "roles" : [
        "master",
        "data",
        "ingest"
      ],
      "process" : {
        "refresh_interval_in_millis" : 1000,
        "id" : 23669,
        "mlockall" : false
      }
    },
    "WVsgYi2HT8GWnZU1kUwFwA" : {
      "name" : "node-2",
      "transport_address" : "10.186.7.221:9300",
      "host" : "10.186.7.221",
      "ip" : "10.186.7.221",
      "version" : "5.5.1",
      "build_hash" : "19c13d0",
      "roles" : [
        "master",
        "data",
        "ingest"
      ],
      "process" : {
        "refresh_interval_in_millis" : 1000,
        "id" : 12641,
        "mlockall" : false
      }
    }
  }
}
			</pre>
			<p>启动节点后回生成 cluster.name 为文件名的日志文件。</p>
			<p>谁先启动谁讲成为master</p>
			<pre class="screen">
[2017-08-11T17:42:46,018][INFO ][o.e.c.s.ClusterService   ] [node-1] new_master {node-1}{-lnKCmBXRpiwExLns0jc9g}{rZcJDIynSzq2Td3yP2kN5A}{10.104.3.2}{10.104.3.2:9300}, added {{node-2}{WVsgYi2HT8GWnZU1kUwFwA}{X13ShUpAQa2zA1Mgcsm3bQ}{10.186.7.221}{10.186.7.221:9300},}, reason: zen-disco-elected-as-master ([1] nodes joined)[{node-2}{WVsgYi2HT8GWnZU1kUwFwA}{X13ShUpAQa2zA1Mgcsm3bQ}{10.186.7.221}{10.186.7.221:9300}]			
			</pre>
			<p>如果master出现故障，其他节点会接管</p>
			<pre class="screen">
[2017-08-11T17:44:52,797][INFO ][o.e.c.s.ClusterService   ] [node-2] master {new {node-2}{WVsgYi2HT8GWnZU1kUwFwA}{vl8kQx8sQdGVVohrNQnZOQ}{10.186.7.221}{10.186.7.221:9300}}, removed {{node-1}{-lnKCmBXRpiwExLns0jc9g}{rZcJDIynSzq2Td3yP2kN5A}{10.104.3.2}{10.104.3.2:9300},}, added {{node-1}{-lnKCmBXRpiwExLns0jc9g}{odnoG9kpQpeX1ltx5KYTSw}{10.104.3.2}{10.104.3.2:9300},}, reason: zen-disco-elected-as-master ([1] nodes joined)[{node-1}{-lnKCmBXRpiwExLns0jc9g}{odnoG9kpQpeX1ltx5KYTSw}{10.104.3.2}{10.104.3.2:9300}]
[2017-08-11T17:44:53,184][INFO ][o.e.c.r.DelayedAllocationService] [node-2] scheduling reroute for delayed shards in [59.5s] (11 delayed shards)
[2017-08-11T17:44:53,929][INFO ][o.e.c.r.a.AllocationService] [node-2] Cluster health status changed from [RED] to [YELLOW] (reason: [shards started [[information][0]] ...]).		
			</pre>
			<p>master 节点恢复上线会提示</p>
			<pre class="screen">
[2017-08-11T17:44:52,855][INFO ][o.e.c.s.ClusterService   ] [node-1] detected_master {node-2}{WVsgYi2HT8GWnZU1kUwFwA}{vl8kQx8sQdGVVohrNQnZOQ}{10.186.7.221}{10.186.7.221:9300}, added {{node-2}{WVsgYi2HT8GWnZU1kUwFwA}{vl8kQx8sQdGVVohrNQnZOQ}{10.186.7.221}{10.186.7.221:9300},}, reason: zen-disco-receive(from master [master {node-2}{WVsgYi2HT8GWnZU1kUwFwA}{vl8kQx8sQdGVVohrNQnZOQ}{10.186.7.221}{10.186.7.221:9300} committed version [44]])
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="loadbalance"></a>8.1.4. 负载均衡配置</h3></div></div></div>
			
			<p>首先安装 nginx, 这里使用 Netkiller OSCM 一键安装脚本完成。</p>
			<pre class="screen">
# curl -s https://raw.githubusercontent.com/oscm/shell/master/web/nginx/stable/nginx.sh | bash
			</pre>
			<p>因为 elasticsearch 没有用户认证机制我们通常在内网访问他。如果对外提供服务需要增加用户认证。</p>
			<p></p>
			<pre class="screen">
			
# printf "neo:$(openssl passwd -crypt s3cr3t)n" &gt; /etc/nginx/passwords 			
			
			</pre>
			<p>创建 nginx 配置文件 /etc/nginx/conf.d/elasticsearch.conf</p>
			<pre class="screen">
upstream elasticsearch {
	server 172.16.0.10:9200;
	server 172.16.0.20:9200;
	server 172.16.0.30:9200;

	keepalive 15;
}

server {
	listen 9200;
	server_name so.netkiller.cn;
	
	charset utf-8;
    access_log /var/log/nginx/so.netkiller.cn.access.log;
    error_log /var/log/nginx/so.netkiller.cn.error.log;
	
	auth_basic "Protected Elasticsearch";
	auth_basic_user_file passwords;

	location ~* ^(/_cluster|/_nodes) {
		return 403;
		break;
	}
    location ~* _(open|close) {
            return 403;
            break;
    }
	location / {
    
		if ($request_filename ~ _shutdown) {
		    return 403;
		    break;
		}

        if ($request_method !~ ^(GET|HEAD|POST)$) {
			return 403;
		}

		proxy_pass http://elasticsearch;
		proxy_http_version 1.1;
		proxy_set_header Connection "Keep-Alive";
		proxy_set_header Proxy-Connection "Keep-Alive";
	}

}
			</pre>
			<p>反复使用下面方法请求，最终你会发现 total_opened 会达到你的nginx 配置数量</p>
			<pre class="screen">
$ curl 'http://test:test@localhost:9200/_nodes/stats/http?pretty' | grep total_opened
# "total_opened" : 15			
			</pre>
			<p>上面的例子适用于绝大多数场景。</p>
			<div class="example"><a id="idp492"></a><p class="title"><strong>例 8.1. Elasticsearch master / slave</strong></p><div class="example-contents">
				
				<pre class="screen">
				
upstream elasticsearch {
	server 172.16.0.10:9200;
	server 172.16.0.20:9200 backup;

	keepalive 15;
}

server {
	listen 9200;
	server_name so.netkiller.cn;
	
	auth_basic "Protected Elasticsearch";
	auth_basic_user_file passwords;

	location ~* ^(/_cluster|/_nodes) {
		return 403;
		break;
	} 

	location / {
    
		if ($request_filename ~ _shutdown) {
		    return 403;
		    break;
		}
		if ($request_method !~ "HEAD") {
          return 403;
          break;
        }
        if ($request_method ~ "DELETE") {
          return 403;
          break;
        }

		proxy_pass http://elasticsearch;
		proxy_http_version 1.1;
		proxy_set_header Connection "Keep-Alive";
		proxy_set_header Proxy-Connection "Keep-Alive";
	}

}
				
				</pre>
			</div></div><br class="example-break" />
			<p>通过 limit_except 可以控制访问权限，例如删除操作。</p>
			<pre class="screen">
			
limit_except PUT {
	allow 192.168.1.1;
	deny all;
}
limit_except DELETE {
	allow 192.168.1.1;
	deny all;
}
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="version"></a>8.1.5. 安装指定版本的 Elasticsearch</h3></div></div></div>
			
			<p>使用 yum 安装默认为最新版本，我们常常会遇到一个问题 elasticsearch-analysis-ik 的版本晚于 Elasticsearch。如果使用 yum 安装 Elasticsearch 可能 elasticsearch-analysis-ik 插件不支持这个版本，有些版本的 elasticsearch-analysis-ik 可以修改插件配置文件中的版本号，使其与elasticsearch版本相同，可以欺骗 elasticsearch 跳过版本不一致异常。</p>
			<p>最佳的解决方案是去 <a class="ulink" href="https://github.com/medcl/elasticsearch-analysis-ik" target="_top">elasticsearch-analysis-ik github</a> 找到兼容的版本，安装我们安装 elasticsearch-analysis-ik 的版本需求来指定安装 elasticsearch</p>
			<p></p>
			<pre class="screen">
Versions

IK version	ES version
master	5.x -&gt; master
5.6.0	5.6.0
5.5.3	5.5.3
5.4.3	5.4.3
5.3.3	5.3.3
5.2.2	5.2.2
5.1.2	5.1.2
1.10.1	2.4.1
1.9.5	2.3.5
1.8.1	2.2.1
1.7.0	2.1.1
1.5.0	2.0.0
1.2.6	1.0.0
1.2.5	0.90.x
1.1.3	0.20.x
1.0.0	0.16.2 -&gt; 0.19.0			
			</pre>
			<p>最新版是 elasticsearch 5.6.1 但分词插件 elasticsearch-analysis-ik 仅能支持到 elasticsearch 版本是 5.6.0 </p>
			<pre class="screen">
root@netkiller /var/log % yum --showduplicates list elasticsearch | expand | tail
Repository epel is listed more than once in the configuration  
elasticsearch.noarch                 5.5.3-1                  elasticsearch-5.x     
elasticsearch.noarch                 5.6.0-1                  elasticsearch-5.x   
elasticsearch.noarch                 5.6.1-1                  elasticsearch-5.x 
			</pre>
			<p>安装 5.6.0</p>
			<pre class="screen">
# yum install elasticsearch-5.6.0-1

Loaded plugins: fastestmirror, langpacks
Repository epel is listed more than once in the configuration
Loading mirror speeds from cached hostfile
Resolving Dependencies
--&gt; Running transaction check
---&gt; Package elasticsearch.noarch 0:5.6.0-1 will be installed
--&gt; Finished Dependency Resolution

Dependencies Resolved

==========================================================================================================================================================================================================
 Package                                            Arch                                        Version                                      Repository                                              Size
==========================================================================================================================================================================================================
Installing:
 elasticsearch                                      noarch                                      5.6.0-1                                      elasticsearch-5.x                                       32 M

Transaction Summary
==========================================================================================================================================================================================================
Install  1 Package

Total download size: 32 M
Installed size: 36 M
Is this ok [y/d/N]: y
			</pre>

		</div>
		<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="plugin"></a>8.1.6. Plugin</h3></div></div></div>
			
			<p>Elasticsearch 提供了插件管理命令 elasticsearch-plugin</p>
			<pre class="screen">
root@netkiller ~ % /usr/share/elasticsearch/bin/elasticsearch-plugin -h
A tool for managing installed elasticsearch plugins

Commands
--------
list - Lists installed elasticsearch plugins
install - Install a plugin
remove - removes a plugin from Elasticsearch

Non-option arguments:
command              

Option         Description        
------         -----------        
-h, --help     show help          
-s, --silent   show minimal output
-v, --verbose  show verbose output			
			</pre>
			<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="elasticsearch-analysis-ik"></a>8.1.6.1. elasticsearch-analysis-ik</h4></div></div></div>
				
				<p>安装插件</p>
				<pre class="screen">
root@netkiller ~ % /usr/share/elasticsearch/bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v5.5.1/elasticsearch-analysis-ik-5.5.1.zip
-&gt; Downloading https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v5.5.1/elasticsearch-analysis-ik-5.5.1.zip
[=================================================] 100%   
-&gt; Installed analysis-ik
				</pre>
				<pre class="screen">
curl -XPOST http://localhost:9200/index/fulltext/_mapping -d'
{
        "properties": {
            "content": {
                "type": "text",
                "analyzer": "ik_max_word",
                "search_analyzer": "ik_max_word"
            }
        }
    
}'			
				</pre>
			</div>
			<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="elasticsearch-analysis-pinyin"></a>8.1.6.2. elasticsearch-analysis-pinyin</h4></div></div></div>
				
				<p>https://github.com/medcl/elasticsearch-analysis-pinyin</p>
			</div>
		</div>
	</div>
	
	
	
	
	
	
	
	
	

	
	
		
	
</div><div xmlns="" id="disqus_thread"></div><script xmlns="">

var disqus_config = function () {
this.page.url = "http://www.netkiller.cn";  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = 'netkiller'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//netkiller.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script><noscript xmlns="">Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><br xmlns="" /><script xmlns="" type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=r5HG&amp;d=9mi5r_kkDC8uxG8HuY3p4-2qgeeVypAK9vMD-2P6BYM"></script><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="../index.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="../index.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="document.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">部分 II. Search Engine </td><td width="20%" align="center"><a accesskey="h" href="../../index.html">起始页</a></td><td width="40%" align="right" valign="top"> 8.2. 文档API</td></tr></table></div><script xmlns="">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-11694057-1', 'auto');
  ga('send', 'pageview');

</script><script xmlns="" async="async">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?93967759a51cda79e49bf4e34d0b0f2c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script xmlns="" async="async">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script><script xmlns="" type="text/javascript" src="/js/q.js" async="async"></script></body></html>